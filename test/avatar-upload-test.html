<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤´åƒä¸Šä¼ æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="file"] {
            padding: 10px;
            cursor: pointer;
        }

        .file-info {
            margin-top: 8px;
            font-size: 12px;
            color: #888;
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .result.loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            display: block;
        }

        .preview {
            margin-top: 20px;
            text-align: center;
        }

        .preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
        }

        .preview-url {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            word-break: break-all;
        }

        .preview-url a {
            color: #667eea;
            text-decoration: none;
        }

        .preview-url a:hover {
            text-decoration: underline;
        }

        .tips {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            color: #666;
        }

        .tips h3 {
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .tips ul {
            margin-left: 20px;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å¤´åƒä¸Šä¼ æµ‹è¯•</h1>

        <div class="form-group">
            <label for="tokenInput">Tokenï¼ˆç™»å½•åè·å–ï¼‰</label>
            <input type="text" id="tokenInput" placeholder="è¯·è¾“å…¥ä½ çš„ JWT Token">
        </div>

        <div class="form-group">
            <label for="fileInput">é€‰æ‹©å¤´åƒå›¾ç‰‡</label>
            <input type="file" id="fileInput" accept="image/*">
            <div class="file-info" id="fileInfo"></div>
        </div>

        <button id="uploadBtn" onclick="uploadAvatar()">ä¸Šä¼ å¤´åƒ</button>

        <div id="result" class="result"></div>

        <div class="preview" id="preview" style="display: none;">
            <h3>ä¸Šä¼ æˆåŠŸï¼</h3>
            <img id="previewImg" src="" alt="å¤´åƒé¢„è§ˆ">
            <div class="preview-url" id="previewUrl"></div>
        </div>

        <div class="tips">
            <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
            <ul>
                <li>1. å…ˆç™»å½•è·å– Tokenï¼Œå¤åˆ¶åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†</li>
                <li>2. é€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼ˆå»ºè®®å°äº 5MBï¼‰</li>
                <li>3. ç‚¹å‡»ä¸Šä¼ æŒ‰é’®</li>
                <li>4. ä¸Šä¼ æˆåŠŸåï¼Œå¤´åƒURLä¼šè‡ªåŠ¨ä¿å­˜åˆ°ä½ çš„è´¦æˆ·</li>
            </ul>
        </div>
    </div>

    <script>
        const apiBase = 'http://localhost:8081'; // ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
        const tokenInput = document.getElementById('tokenInput');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const resultDiv = document.getElementById('result');
        const previewDiv = document.getElementById('preview');
        const previewImg = document.getElementById('previewImg');
        const previewUrl = document.getElementById('previewUrl');
        const fileInfo = document.getElementById('fileInfo');

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `æ–‡ä»¶å: ${file.name} | å¤§å°: ${fileSize} MB | ç±»å‹: ${file.type}`;
            } else {
                fileInfo.textContent = '';
            }
        });

        async function uploadAvatar() {
            // 1. è·å–è¾“å…¥å€¼
            let token = tokenInput.value.trim();
            const file = fileInput.files[0];

            // 2. æ ¡éªŒè¾“å…¥
            if (!token) {
                showResult('è¯·å…ˆè¾“å…¥ Token', 'error');
                return;
            }

            if (!file) {
                showResult('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // 3. æ ¡éªŒæ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                showResult('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB', 'error');
                return;
            }

            // 4. ç¡®ä¿Tokenæ ¼å¼æ­£ç¡®
            if (!token.startsWith('Bearer ')) {
                token = 'Bearer ' + token;
            }

            // 5. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            uploadBtn.disabled = true;
            showResult('æ­£åœ¨ä¸Šä¼ ...', 'loading');

            try {
                // 6. åˆ›å»ºFormData
                const formData = new FormData();
                formData.append('avatar', file);

                console.log('å¼€å§‹ä¸Šä¼ ï¼ŒURL:', `${apiBase}/api/v1/users/avatar`);
                console.log('Token:', token.substring(0, 20) + '...');
                console.log('æ–‡ä»¶:', file.name, file.size, 'bytes');

                // 7. å‘é€è¯·æ±‚
                const response = await fetch(`${apiBase}/api/v1/users/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token
                        // æ³¨æ„ï¼šä¸è¦è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½® multipart/form-data
                    },
                    body: formData,
                    mode: 'cors' // æ˜ç¡®æŒ‡å®š CORS
                });

                console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);

                // 8. æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('å“åº”é”™è¯¯:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }

                // 9. è§£æå“åº”
                const result = await response.json();
                console.log('å“åº”æ•°æ®:', result);
                console.log('code å€¼:', result.code, 'ç±»å‹:', typeof result.code);

                // åˆ¤æ–­æˆåŠŸï¼šcode === 0 æˆ–è€…æœ‰ avatar_url ä¸” message åŒ…å«"æˆåŠŸ"
                const isSuccess = result.code === 0 || 
                                 (result.avatar_url && (result.message && result.message.includes('æˆåŠŸ')));
                
                if (isSuccess) {
                    // ä¸Šä¼ æˆåŠŸ
                    showResult('âœ… ä¸Šä¼ æˆåŠŸï¼', 'success');
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    if (result.avatar_url) {
                        previewImg.src = result.avatar_url;
                        previewUrl.innerHTML = `å¤´åƒURL: <a href="${result.avatar_url}" target="_blank">${result.avatar_url}</a>`;
                        previewDiv.style.display = 'block';
                    }
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    fileInput.value = '';
                    fileInfo.textContent = '';
                } else {
                    // ä¸Šä¼ å¤±è´¥
                    showResult(`âŒ ä¸Šä¼ å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    previewDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                let errorMsg = `âŒ é”™è¯¯: ${error.message}`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += '<br><br>ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š<br>1. æœåŠ¡å™¨æœªè¿è¡Œï¼ˆæ£€æŸ¥ http://localhost:8081ï¼‰<br>2. CORS é—®é¢˜ï¼ˆå»ºè®®é€šè¿‡ HTTP æœåŠ¡å™¨æ‰“å¼€æ­¤é¡µé¢ï¼‰<br>3. ç½‘ç»œè¿æ¥é—®é¢˜<br>4. è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯';
                }
                
                showResult(errorMsg, 'error');
                previewDiv.style.display = 'none';
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function showResult(message, type) {
            resultDiv.innerHTML = message; // ä½¿ç”¨ innerHTML æ”¯æŒ HTML æ ¼å¼
            resultDiv.className = `result ${type}`;
        }

        // æ”¯æŒå›è½¦é”®ä¸Šä¼ 
        tokenInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                uploadAvatar();
            }
        });
    </script>
</body>
</html>

