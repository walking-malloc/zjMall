## 订单服务需求文档（PRD）

### 1. 背景与目标（产品视角）

- **背景**
  - 当前系统已经具备用户、商品、购物车、库存、促销等基础能力，需要一个统一的「订单中心」承载交易主线，串起下单、支付、履约、售后等业务。
  - 订单相关能力（下单校验、价格重算、库存预占、状态流转、取消与超时处理等）是电商系统的核心，需要独立为一个服务，便于扩展与风控。
  - 未来会叠加大促、复杂促销、多仓履约、售后等能力，订单服务需要预留扩展空间。

- **目标**
  - 搭建**独立的订单服务**，作为平台唯一的订单事实来源。
  - 打通「结算预览 → 创建订单 → 支付 → 发货 → 收货 → 完成/关闭」全链路订单状态机。
  - 与商品、库存、促销、支付、物流、售后等服务解耦，通过清晰接口协作。
  - 支持后续扩展：多仓拆单、多商户、部分发货、预售、预约单等场景。

---

### 2. 角色与典型使用场景

#### 2.1 角色定义

- **前台用户（C 端）**
  - 从购物车或商品详情页发起下单、支付、查看订单进度、取消订单、确认收货。
- **平台运营（OP）**
  - 在运营/管理后台查看订单列表、订单详情，执行人工取消、价格调整（预留）、备注、标记、导出报表等。
- **仓储/发货人员（WMS/OMS）**
  - 根据订单进行拣货、打包、出库，更新发货/物流信息（本期可简化为运营代操作）。
- **客服（CS）**
  - 查询订单信息，协助用户处理异常（未收到货、错发、漏发等），配合售后处理。
- **其他服务**
  - 商品服务、库存服务、促销服务、支付服务、物流服务、售后服务等，通过接口与订单服务交互。

#### 2.2 核心用户故事（首期）

- **故事 1：用户从购物车提交订单**
  - 作为 C 端用户，我在购物车勾选商品后发起结算，系统能校验商品是否可售、价格是否最新、库存是否足够，并在确认页展示应付金额，最终创建一个「待支付」订单。

- **故事 2：订单支付与超时取消**
  - 作为用户，我点击「去支付」后完成支付，支付成功时订单自动更新为「待发货」；若在限定时间内未支付，系统自动关闭订单并释放库存。

- **故事 3：发货与收货**
  - 作为运营/仓储人员，我可以在后台为订单填写物流公司与运单号，系统将订单状态更新为「待收货」；用户收到货后可确认收货，订单变为「已完成」。

- **故事 4：用户主动取消订单**
  - 在订单未支付或未发货前，用户可以主动取消订单，系统需要撤销库存预占（或提示已发货无法取消）。

- **故事 5：客服查询与标记订单**
  - 客服可以通过用户手机号/订单号查询订单详情，查看状态变更日志，并对异常订单添加备注、标签（如「催发货」「异常处理」）。

---

### 3. 业务范围与边界

**订单服务主要负责：**

1. **订单建模与存储**
   - 订单主表：订单基本信息（订单号、用户、金额、状态、渠道、创建/支付/发货/完成时间等）。
   - 订单明细表：按 SKU 维度记录商品信息（商品标题、SKU 名称、单价、数量、优惠分摊等）。
   - 订单扩展字段：收货地址快照、发票信息、买家留言、商家/客服备注等。

2. **下单流程与校验**
   - 从购物车或直接购买发起下单请求。
   - 调用**商品服务**校验商品与 SKU 是否存在且可售（已上架、未下架、未删除）。
   - 调用**促销服务**或结算预览结果进行价格/优惠重算（首期可先使用购物车结算预览结果，订单服务仅做价格复算与兜底）。
   - 调用**库存服务**执行库存预占（Reserve），失败则返回下单失败原因。

3. **订单金额计算**
   - 支持以下金额字段：
     - 商品原价总额（商品现价 * 数量汇总）。
     - 优惠金额（促销优惠 + 优惠券优惠等，首期可合并为一个字段）。
     - 运费金额（首期可固定为 0 或简单规则）。
     - 订单应付金额（原价总额 - 优惠 + 运费，且不小于 0）。
   - 价格变动规则：以订单创建时重算结果为准，**下单后价格不再随商品价变动**。

4. **订单状态机管理**
   - 典型状态：`待支付` → `待发货` → `待收货` → `已完成` / `已关闭`。
   - 中间可能出现：`待确认`（预留）、`部分发货`（后续扩展）、`退款中/已退款`（与售后配合）。
   - 支持的状态变迁：
     - 用户创建订单：`新建` → `待支付`。
     - 支付成功回调：`待支付` → `待发货`。
     - 用户或系统取消：`待支付` → `已关闭`（同时释放库存预占）。
     - 发货操作：`待发货` → `待收货`。
     - 用户确认收货或自动确认：`待收货` → `已完成`。

5. **订单查询与列表**
   - C 端查询：我的订单列表（按状态过滤：全部、待支付、待发货、待收货、已完成、已关闭），订单详情页。
   - 后台查询：按用户、订单号、时间、渠道、状态等多维度筛选，并可导出（预留）。

6. **与其他服务的交互**
   - **购物车服务**：接受结算预览/提交结算时传入的购物车项列表，成功创建订单后可选择清理对应购物车项。
   - **库存服务**：预占库存、取消订单时解占库存、支付成功后转为真实扣减（首期可合并为预占+支付成功扣减，未支付超时解占）。
   - **支付服务**：创建支付单、接收支付结果回调，更新订单支付状态。
   - **物流/履约服务**：发货时创建或更新包裹与物流信息（首期可简化为在订单上记录物流公司与单号）。
   - **售后服务**：订单状态为「已完成」或「待收货」时允许发起售后，售后完成后写回订单售后标记。

**本期不包含（预留后续迭代）：**

- 多商户订单、店铺维度拆单。
- 多仓/波次/智能分单。
- 预售、预约、虚拟商品码发放等复杂交易模型。
- 复杂结算与分账、财务票据。

---

### 4. 核心业务流程说明

#### 4.1 提交订单（从购物车结算）

**文字流程：**

1. 用户在前端选择购物车中的若干项，调用购物车服务的结算预览接口，得到预估金额与可用优惠信息。
2. 用户在确认页点击「提交订单」，前端向订单服务发起 `CreateOrder` 请求（携带选中的购物车项 ID、收货地址、优惠券 ID 等）。
3. 订单服务执行以下步骤：
   - 根据购物车项 ID 拉取购物车快照（或由前端直接提交 SKU+数量+价格快照）。
   - 调用商品服务校验商品状态与价格（必要时重算价格，以商品最新价格为基准+促销）。
   - 调用促销服务计算最终优惠与应付金额（若本期暂未实现，可先使用购物车预览结果并在订单侧复算一遍）。
   - 调用库存服务预占库存（按 SKU+数量）。
   - 所有校验通过后生成订单记录（主表+明细），状态为「待支付」。
4. 返回订单号与应付金额给前端，前端跳转收银台/支付页。

#### 4.2 支付结果处理

1. 用户在收银台完成支付，支付服务向订单服务发起「支付成功回调」。
2. 订单服务根据支付单关联的订单号：
   - 校验当前订单状态是否为「待支付」，幂等处理重复回调。
   - 更新订单状态为「待发货」，记录支付时间、支付渠道、支付流水号等。
   - 调用库存服务：将预占库存转为实际扣减（若库存服务设计为预占即实际扣减，可仅做确认）。
3. 向消息总线（MQ，若有）发送「订单已支付」事件，供后续系统使用。

#### 4.3 订单取消与超时关闭

1. **用户主动取消（未支付）**
   - 前端发起取消请求，订单服务校验当前状态为「待支付」，允许取消。
   - 更新订单状态为「已关闭」，记录取消原因（用户取消），调用库存服务释放预占库存。

2. **系统超时取消**
   - 通过定时任务或延迟队列扫描/消费「待支付」订单，超过设定时间未支付则自动取消。
   - 与用户取消同样的流程：更新状态、记录原因（超时未支付）、释放库存。

#### 4.4 发货与收货

1. 发货：
   - 运营/仓储在后台为订单录入物流公司与运单号，订单状态从「待发货」变为「待收货」。
   - 记录发货时间、发货人等信息。
2. 收货：
   - 用户在前端点击「确认收货」，或系统在发货后 N 天自动确认。
   - 订单状态从「待收货」变为「已完成」，记录完成时间。

---

### 5. 功能需求列表（带验收要点）

#### 5.1 创建订单（下单接口）

- **输入**
  - 用户 ID（从登录态获取）。
  - 订单来源（购物车 / 立即购买）。
  - 商品列表：SPU/SKU ID、数量、单价快照等。
  - 收货地址 ID 或地址快照。
  - 优惠券 ID（可选）、买家留言（可选）。
- **处理逻辑（验收要点）**
  - 校验用户已登录。
  - 校验商品存在且可售（调用商品服务）。
  - 校验库存充足（调用库存服务预占）。
  - 校验优惠券是否可用（与促销/券服务协作，本期可预留）。
  - 重新计算订单金额并与前端传入金额对比，不一致则以服务端为准返回。
  - 成功时写入订单主表与明细表，状态为「待支付」。
- **输出**
  - 订单号、应付金额、支付超时时间等。

#### 5.2 订单支付回调处理

- 支持支付服务通过订单号通知订单服务支付结果。
- 幂等保障：重复回调不应导致状态错乱或重复扣减。
- 状态只能从「待支付」流转到「待发货」，其他状态回调需忽略并记录日志。

#### 5.3 订单取消

- **用户端取消**
  - 仅允许在「待支付」或特定条件下的「待发货」之前（根据业务规则，本期只支持待支付）。
  - 取消后释放库存预占。
- **系统超时取消**
  - 需配置订单支付超时时间（例如 30 分钟）。
  - 通过定时任务/延迟队列自动关闭超时未支付订单。

#### 5.4 订单查询与列表

- **用户端**
  - 查询我的订单列表（支持按状态筛选与分页）。
  - 查看订单详情，包括商品列表、金额明细、物流信息、状态流转记录等。
- **后台端**
  - 支持按订单号、用户 ID、手机号、时间、状态、渠道等维度查询。
  - 支持导出订单列表（可后续迭代）。

#### 5.5 发货与物流信息维护

- 后台提供接口/页面录入物流公司与运单号。
- 订单状态从「待发货」变为「待收货」，记录发货时间。
- 可预留与第三方物流接口对接（目前只做静态字段）。

#### 5.6 订单日志与审计

- 每次状态变更需记录日志：操作类型、前后状态、操作者、操作时间、备注。
- 关键金额字段变更（若有）需额外记录审计信息。

---

### 6. 非功能与扩展要求（订单维度）

- **一致性**
  - 下单与库存预占必须具备基本一致性：订单创建失败时不得留下多余的预占记录。
  - 支付回调与库存扣减应具备幂等性（按订单号或业务流水号去重）。
- **性能**
  - 正常日常峰值下单 QPS 需在合理范围内（可参照整体电商目标），创建订单接口 P95 < 300ms 为目标。
- **可观测性**
  - 为关键流程埋点：创建订单、支付成功、取消、发货、完成等，支持链路追踪与告警。
- **扩展性预留**
  - 订单结构需预留商家维度、仓维度字段，为后续多商户、多仓拆单做准备。
  - 接口设计时尽量以「订单号」为核心主键，同时支持「外部单号」「支付单号」等扩展标识。

---

以上为本项目中「订单服务」的本地需求文档（PRD）初稿，可在此基础上与产品/开发/测试进一步评审和细化，再拆解为技术设计与开发任务。


