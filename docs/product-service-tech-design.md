## 商品服务技术方案说明

> 本文档从技术视角描述商品服务的整体设计方案，包括架构、模块划分、数据设计、接口设计、与其他服务的交互方式、非功能性要求等，不涉及具体代码实现细节。

---

### 1. 总体架构设计

#### 1.1 架构定位

- 商品服务作为独立的业务微服务，承担「商品中心」的角色，为多个前台应用（Web/H5/小程序/App）及内部服务（订单、库存、营销、搜索、推荐等）提供统一的商品相关能力。
- 服务采用 **微服务架构**，对外暴露统一的 gRPC + HTTP/REST 接口，内部采用数据库 + 缓存 + 消息队列等组件进行数据存储与异步解耦。

#### 1.2 逻辑架构分层

商品服务整体逻辑分为以下几层：

- **API 接入层**
  - 提供 gRPC 接口以及 gRPC-Gateway 暴露的 HTTP/JSON 接口。
  - 负责请求路由、参数解析、基础校验、认证鉴权（配合统一网关或中间件）。

- **应用服务层（Service）**
  - 承载商品相关的应用服务逻辑，如商品创建、编辑、上下架、查询等。
  - 实现参数校验、业务规则编排、调用领域服务与资源服务（仓储、缓存、外部接口）。

- **领域模型与领域服务层（Domain）**
  - 定义商品领域的核心实体与值对象（SPU、SKU、类目、品牌、属性、标签等）。
  - 实现相对稳定的领域规则（如 SKU 规格组合校验、状态机转换规则）。

- **基础资源访问层（Repository & Infra）**
  - 封装对数据库、缓存系统、搜索引擎、消息队列等外部资源的访问。
  - 提供统一的仓储接口，隐藏具体存储实现细节。

- **集成与适配层（Integration）**
  - 封装与库存服务、订单服务、营销服务、搜索服务等外部系统的接口调用。
  - 通过 RPC/HTTP/MQ 等方式进行交互，提供幂等控制与故障恢复策略。

---

### 2. 模块划分

商品服务内部建议按业务域进行模块拆分，每个模块既有各自的模型和仓储，又共享一些基础设施。

#### 2.1 类目模块（Category Module）

- **职责**
  - 管理商品类目树结构。
  - 提供类目增删改查、排序、启停用功能。
  - 提供供前台展示的类目树形结构。

- **主要功能模块**
  - 类目维护子系统（后台）
  - 类目树查询接口（前台/其他服务）
  - 类目与属性模板关联管理

#### 2.2 品牌模块（Brand Module）

- **职责**
  - 维护品牌基础信息及其与类目的关联关系。
  - 提供品牌列表、品牌详情、按类目过滤品牌的能力。

#### 2.3 属性与规格模块（Attribute Module）

- **职责**
  - 管理类目属性模板（销售属性、非销售属性）。
  - 管理属性值选项（如颜色、尺码等）。
  - 为商品创建和编辑提供属性模板支持。

#### 2.4 商品（SPU）模块（Product/SPU Module）

- **职责**
  - 管理商品 SPU 级别的信息（名称、副标题、描述、图文详情、关联类目和品牌等）。
  - 管理商品生命周期状态（草稿、待审核、已上架、已下架、已删除）。
  - 提供商品维度查询接口（详情和列表）。

#### 2.5 SKU 模块（SKU Module）

- **职责**
  - 管理 SKU 级别的信息（规格组合、价格、条形码、重量、体积、状态等）。
  - 维护 SKU 与库存服务之间的映射关系。
  - 提供 SKU 维度的查询与校验能力。

#### 2.6 价格与标签模块（Price & Tag Module）

- **职责**
  - 管理商品/sku 的标准价格、划线价、成本价等字段。
  - 预留多价格维度（如渠道价、会员价）能力。
  - 管理与商品关联的标签（新品、热销、清仓等）。

#### 2.7 审核与日志模块（Audit & Log Module）

- **职责**
  - 记录商品创建/修改/审核/上下架等操作行为。
  - 提供审核流转记录的存储与查询能力。

#### 2.8 对接模块（Integration Module）

- **主要对接对象**
  - **库存服务**：获取可售库存、同步 SKU 静态信息。
  - **订单服务**：提供订单创建时商品和 SKU 信息查询、价格校验能力。
  - **搜索服务**：通过消息推送商品变更事件（新增、修改、上下架），供搜索建立/更新索引。
  - **营销服务**：提供商品基础信息、类目和品牌信息，用于规则配置和优惠计算。
  - **内容安全/风控服务**：对商品标题、描述、图片等进行审核。

---

### 3. 数据模型设计（逻辑层面）

> 本节描述的是逻辑模型与字段含义，不给出具体 SQL/DDL，仅说明实体及关系。

#### 3.1 类目实体（Category）

- **核心字段**
  - `ID`：类目唯一标识（建议使用与用户服务相同的 ULID 方案）。
  - `ParentID`：父类目 ID，顶级类目为 NULL。
  - `Name`：类目名称。
  - `Level`：类目层级（1/2/3/...）。
  - `IsLeaf`：是否为叶子节点。
  - `IsVisible`：是否在前台展示。
  - `SortOrder`：排序权重。
  - `Status`：状态（启用/停用）。

- **关系**
  - 一对多：一个类目下有多个子类目。
  - 一对多：一个类目下可以有多个商品（SPU）。

#### 3.2 品牌实体（Brand）

- **核心字段**
  - `ID`：品牌唯一标识。
  - `Name`：品牌名称。
  - `LogoURL`：品牌 LOGO 地址。
  - `Country`：所属国家/地区。
  - `Description`：品牌描述。
  - `Status`：状态（启用/停用）。

- **关系**
  - 多对多：品牌与类目之间通常为多对多关系，可通过中间表维护。

#### 3.3 商品 SPU 实体（Product/SPU）

- **核心字段**
  - `ID`：SPU ID。
  - `CategoryID`：所属类目 ID。
  - `BrandID`：品牌 ID。
  - `Title`：商品标题。
  - `SubTitle`：商品副标题。
  - `MainImage`：主图 URL。
  - `Images`：图片列表（序列化字段）。
  - `Description`：富文本详情（图文描述）。
  - `Status`：状态（草稿、待审核、已上架、已下架、已删除等）。
  - `OnShelfTime`：上架时间（可为空）。
  - `OffShelfTime`：下架时间（可为空）。
  - `Tags`：标签集合（可用多对多表或 JSON 字段存储）。

- **关系**
  - 一对多：一个 SPU 对应多个 SKU。
  - 多对一：SPU 属于一个类目。
  - 多对一：SPU 属于一个品牌。

#### 3.4 SKU 实体（ProductSKU）

- **核心字段**
  - `ID`：SKU ID。
  - `ProductID`：所属 SPU ID。
  - `SKUCode`：SKU 编码（内部）。
  - `Barcode`：条形码。
  - `Name`：SKU 名称（如：黑色 128G）。
  - `Price`：销售价格。
  - `OriginalPrice`：划线价。
  - `CostPrice`：成本价。
  - `Weight`：重量。
  - `Volume`：体积。
  - `Status`：状态（上架/下架/禁用）。

- **关系**
  - 多对一：SKU 归属一个 SPU。
  - 多对多：SKU 与属性值之间存在多对多关系（通过中间表维护）。

#### 3.5 属性与属性值实体（Attribute & AttributeValue）

- **Attribute**
  - `ID`：属性 ID。
  - `CategoryID`：所属类目 ID。
  - `Name`：属性名称。
  - `Type`：属性类型（销售属性/非销售属性）。
  - `InputType`：录入方式（文本、下拉、多选等）。
  - `IsRequired`：是否必填。

- **AttributeValue**
  - `ID`：属性值 ID。
  - `AttributeID`：所属属性 ID。
  - `Value`：属性值名称。

- **关系**
  - 一对多：一个属性有多个属性值。
  - 多对多：SKU 与属性值之间的映射关系。

#### 3.6 标签实体（Tag）

- **核心字段**
  - `ID`：标签 ID。
  - `Name`：标签名。
  - `Type`：标签类型（系统标签/运营标签等）。
  - `Status`：状态。

- **关系**
  - 多对多：SPU 与标签之间是多对多关系。

#### 3.7 审核与日志实体（AuditLog / OperationLog）

- **AuditLog**
  - `ID`：审核记录 ID。
  - `TargetID`：审核对象 ID（如商品、SKU 等）。
  - `TargetType`：审核对象类型。
  - `Action`：操作（提交审核/通过/驳回）。
  - `Result`：结果。
  - `Reason`：原因说明。
  - `Operator`：操作人。
  - `CreatedAt`：时间戳。

- **OperationLog**
  - 记录商品相关的所有重要变更行为。

---

### 4. 接口设计（高层次）

> 以下为接口能力概览，具体字段、分页参数、错误码需在 API 文档中细化。

#### 4.1 对内/对外暴露的主要接口能力

1. **类目相关接口**
   - 查询类目树。
   - 查询类目详情。
   - 后台：创建/修改/删除类目。

2. **品牌相关接口**
   - 查询品牌列表（可按类目过滤）。
   - 查询品牌详情。
   - 后台：创建/修改/删除品牌。

3. **商品 SPU 接口**
   - 创建商品 SPU（后台）。
   - 编辑商品 SPU。
   - 查询商品详情（对前台/订单/营销开放）。
   - 商品列表查询（支持多条件过滤）。
   - 商品上下架控制（后台）。

4. **SKU 接口**
   - 创建/编辑 SKU 信息（后台）。
   - 根据 SPU ID 查询 SKU 列表。
   - 根据 SKU ID 批量查询 SKU 基础信息。

5. **属性与规格接口**
   - 查询某类目的属性模版（前台用于商品发布页面）。
   - 后台：管理属性和属性值列表。

6. **标签与分组接口**
   - 查询某个商品的标签信息。
   - 为商品打标签/取消标签（后台）。

7. **审核与日志接口**
   - 获取商品的审核记录列表。
   - 查询商品变更日志。

8. **与其他服务的集成接口**
   - 订单服务：下单时批量校验商品和 SKU 的可售状态、价格、标题等。
   - 库存服务：查询 SKU 的可售库存信息。
   - 搜索服务：订阅商品变更事件，更新搜索索引。
   - 营销服务：拉取商品和类目基础信息进行规则配置。

---

### 5. 与其他服务的交互设计

#### 5.1 与库存服务

- **读取方向**
  - 商品服务在前台展示可售库存时，调用库存服务接口获取实时可售量。
- **写入方向**
  - 商品服务在创建/变更 SKU 时，将与库存相关的静态信息（如单位、体积、重量）同步给库存服务。
- **一致性策略**
  - 采用「商品服务负责静态信息，库存服务负责数量信息」的职责划分。
  - 通过事件或定时任务进行数据对账，发现异常及时告警。

#### 5.2 与订单服务

- **下单前校验**
  - 订单服务在创建订单或计算价格前，调用商品服务：
    - 校验商品/sku 是否存在且可售。
    - 获取当前价格与展示信息。
- **降级策略**
  - 若商品服务出现短暂不可用，可根据业务容忍度决定：
    - 暂停下单（严格一致性）。
    - 使用缓存/兜底数据（弱一致性）。

#### 5.3 与搜索服务

- **同步方式**
  - 商品新增、编辑、上下架时，商品服务将变更事件写入消息队列。
  - 搜索服务订阅事件，对搜索索引进行增量更新。

- **事件内容**
  - 商品 ID、变更类型（新增/修改/上下架）、变更时间等。

#### 5.4 与营销服务

- 商品服务提供：
  - 商品基础信息、类目信息、品牌信息。
  - 用于配置促销活动适用范围（如指定类目、指定商品、指定品牌）。

#### 5.5 与用户服务

- 商品服务可根据需要关联商家/店铺信息（若存在多商户场景）。
- 用户服务为商品服务提供操作人信息（用于审核/日志记录）。

---

### 6. 缓存与性能设计（概念级）

> 本节仅从策略层面说明，不描述具体缓存中间件和实现代码。

#### 6.1 缓存目标对象

- 商品详情（SPU + 默认 SKU 信息）。
- 类目树结构（读取频率高、更新频率相对较低）。
- 品牌列表、属性模版（相对静态的数据）。

#### 6.2 缓存策略

- 采用 **Cache Aside（旁路缓存）模式**：
  - 读取：先读缓存，未命中则读数据库并回填缓存。
  - 写入：更新数据库后，再删除或更新缓存。

- 避免缓存穿透、击穿、雪崩：
  - 对不存在的商品 ID 可缓存空值一段时间，防止频繁访问数据库。
  - 对热门商品设置合理的过期时间，并结合互斥锁/请求合并防止击穿。
  - 通过随机过期时间、分片刷新等方式避免大量 key 同时失效。

---

### 7. 一致性与事务设计（概念级）

- **强一致性需求**
  - 商品状态（上架/下架）与搜索/缓存等系统之间的一致性。
  - SKU 与库存服务之间的 SKU 定义一致性。

- **事务策略**
  - 单服务内操作使用本地事务（如 SPU 与 SKU 的同时写入）。
  - 跨服务操作采用：
    - 事件驱动 + 最终一致性（通过 MQ 或 Outbox 模式）。
    - 幂等接口设计，确保重复消费不会产生错误副作用。

---

### 8. 安全与权限设计（概念级）

- **访问控制**
  - 后台管理接口需要基于角色和权限体系进行控制。
  - 区分平台运营、商家运营、只读用户等不同角色的权限。

- **数据安全**
  - 对内部敏感字段（如成本价）进行权限隔离，不向无权限角色返回。
  - 对外接口做参数校验和频率限制，防止恶意调用和批量爬取。

- **审计与合规**
  - 对所有关键操作（上架、下架、价格修改、类目调整等）记录操作日志。
  - 保留变更历史用于审计和问题追踪。

---

### 9. 监控与运维（概念级）

- **监控指标**
  - 接口 QPS、响应时间（P50/P90/P99）。
  - 错误率（按接口、按调用方统计）。
  - 关键业务指标（上架商品数量、各类目商品分布等）。

- **日志与追踪**
  - 使用统一的日志规范输出结构化日志，便于检索和聚合分析。
  - 接入全链路追踪系统，为调用链分析提供支持。

- **告警策略**
  - 核心接口错误率、延迟超阈值时触发告警。
  - 底层依赖（数据库、缓存、MQ）异常时联动告警。

---

### 10. 可扩展性与演进方向

- **多租户支持**
  - 未来可通过在数据模型中增加租户字段，支持多租户商品隔离。

- **多语言与多站点**
  - 为标题、描述等字段增加多语言扩展方案。
  - 针对不同站点配置不同的展示内容与价格策略。

- **规则引擎集成**
  - 与规则引擎（如营销、推荐）结合，实现更多智能化能力。

---

本技术方案为商品服务的整体设计蓝图，后续可在此基础上：
- 细化 API 规格与错误码定义；
- 输出具体的数据表结构设计文档；
- 制定性能压测方案与容量规划；
- 结合现有基础设施（如网关、中间件）进行具体落地实现。


