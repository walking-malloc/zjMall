# 购物车服务需求文档（PRD）

## 1. 背景与目标

### 1.1 背景
购物车是电商平台的核心功能之一，是连接"浏览商品"和"下单支付"的重要桥梁。用户在浏览商品时，可以将感兴趣的商品加入购物车，统一管理，方便后续批量结算。

### 1.2 目标
- 提供便捷的商品加购、管理功能，提升用户购物体验
- 支持跨端（Web/APP/小程序）购物车数据同步，提升用户粘性
- 实时展示商品价格、库存、优惠信息，帮助用户做出购买决策
- 提供结算预览功能，让用户在下单前清楚了解最终价格和优惠明细
- 支持大促场景下的高并发访问，确保系统稳定可用

### 1.3 非目标（首期不做）
- 购物车商品过期自动清理（暂定永久保存，后续可优化）
- 购物车分享功能
- 购物车商品推荐功能
- 购物车限时特价提醒功能

---

## 2. 用户角色与使用场景

### 2.1 用户角色
- **C端用户**：浏览商品、加购、管理购物车、结算

### 2.2 核心使用场景

#### 场景 1：添加商品到购物车
**用户故事**：用户在商品详情页浏览商品，选择好规格（SKU）和数量后，点击"加入购物车"按钮，希望商品能够成功添加到购物车中。

**用户期望**：
- 点击后能立即看到成功提示
- 购物车图标上的商品数量能实时更新
- 如果商品库存不足或已下架，能明确提示原因

#### 场景 2：查看购物车
**用户故事**：用户想查看自己购物车中的所有商品，了解总价和优惠情况，准备进行结算。

**用户期望**：
- 能看到所有已添加的商品信息（图片、名称、规格、价格、数量）
- 能看到每个商品的小计金额
- 能看到购物车的总金额和优惠信息
- 能清楚看到哪些商品已失效（下架/无库存）

#### 场景 3：修改购物车商品
**用户故事**：用户想修改购物车中某个商品的数量，或者删除不需要的商品。

**用户期望**：
- 能方便地增加或减少商品数量
- 能直接输入数量
- 如果数量超过库存上限，能明确提示
- 能快速删除单个商品或批量删除多个商品
- 删除后购物车总价能实时更新

#### 场景 4：结算预览
**用户故事**：用户准备下单，想在下单前了解最终需要支付多少钱，包括商品价格、优惠金额、运费等。

**用户期望**：
- 能看到选中商品的详细信息和价格
- 能看到所有优惠明细（满减、优惠券、会员价等）
- 能看到配送地址和运费信息
- 能看到预计送达时间
- 能看到最终实付金额

#### 场景 5：跨端同步
**用户故事**：用户在手机 APP 上添加了商品到购物车，后来在 PC 端打开网站，希望看到同样的购物车内容。

**用户期望**：
- 登录后能自动同步所有端的购物车数据
- 数据同步及时准确
- 如果未登录时添加了商品，登录后能自动合并到购物车

---

## 3. 功能需求

### 3.1 添加商品到购物车

#### 功能描述
用户可以将商品（SKU）添加到购物车，支持指定数量。

#### 业务规则
1. 用户必须登录才能添加商品到购物车
2. 只能添加已上架的商品
3. 只能添加已上架且有库存的 SKU
4. 添加数量必须大于 0，且不能超过当前库存
5. 如果购物车中已存在相同 SKU，则累加数量（不超过库存上限）
6. 购物车中商品总数不超过 100 个（可配置限制）

#### 用户操作流程
1. 用户在商品详情页选择 SKU 和数量
2. 点击"加入购物车"按钮
3. 系统校验商品状态和库存
4. 如果校验通过，添加成功并提示用户
5. 如果校验失败，提示用户具体原因（如：库存不足、商品已下架）

#### 异常情况处理
- **商品已下架**：提示"该商品已下架，无法加入购物车"
- **SKU 已下架**：提示"该规格已下架，无法加入购物车"
- **库存不足**：提示"库存不足，当前库存 X 件"
- **购物车已满**：提示"购物车已满，请先删除部分商品"

---

### 3.2 查看购物车列表

#### 功能描述
用户可以查看购物车中所有商品，包括商品信息、价格、库存状态、优惠信息等。

#### 业务规则
1. 用户必须登录才能查看购物车
2. 购物车商品按添加时间倒序排列（最新添加的在前面）
3. 自动过滤已删除的商品
4. 实时显示商品价格（调用商品服务获取最新价格）
5. 实时显示库存状态（有库存/库存不足/无库存）
6. 显示商品优惠信息（如有促销活动、会员价等）
7. 失效商品（下架/无库存）需要明确标识，但不自动删除

#### 展示内容
- **商品信息**：商品图片、商品名称、商品 ID
- **SKU 信息**：SKU 名称、规格属性（如：颜色、尺寸）
- **价格信息**：单价、原价（如有促销）、小计金额
- **数量信息**：当前数量、库存数量
- **状态信息**：是否有效、失效原因（如有）
- **优惠信息**：促销活动名称、优惠金额（如有）
- **操作按钮**：修改数量、删除商品

#### 汇总信息
- 商品总数（有效商品数量）
- 商品总数量（所有商品数量之和）
- 商品总金额（所有商品小计之和）
- 总优惠金额（所有优惠之和）
- 是否有失效商品

---

### 3.3 修改购物车商品数量

#### 功能描述
用户可以修改购物车中商品的数量，支持增加、减少或直接输入。

#### 业务规则
1. 用户必须登录
2. 数量必须大于 0
3. 数量不能超过当前库存上限
4. 实时校验库存，如果库存不足，提示用户并限制数量
5. 修改后实时计算价格变化

#### 用户操作方式
- **增加数量**：点击"+"按钮，每次增加 1
- **减少数量**：点击"-"按钮，每次减少 1（数量为 1 时不能减少，只能删除）
- **直接输入**：在数量输入框中直接输入数字

#### 异常情况处理
- **库存不足**：当用户输入的数量超过库存时，自动调整为最大库存数，并提示"库存不足，已调整为最大可购买数量"
- **数量为 0**：如果数量被调整为 0，提示用户是否删除该商品

---

### 3.4 删除购物车商品

#### 功能描述
用户可以从购物车中删除商品，支持单个删除和批量删除。

#### 业务规则
1. 用户必须登录
2. 支持删除单个商品
3. 支持批量删除多个商品（用户勾选后批量删除）
4. 删除后实时更新购物车统计信息

#### 用户操作方式
- **单个删除**：点击商品旁边的"删除"按钮
- **批量删除**：勾选多个商品后，点击"批量删除"按钮
- **全选删除**：勾选"全选"后，点击"删除选中"按钮

#### 确认机制
- 单个删除：直接删除（前端可加二次确认，可选）
- 批量删除：建议有二次确认提示，避免误操作

---

### 3.5 清空购物车

#### 功能描述
用户可以一键清空购物车中的所有商品。

#### 业务规则
1. 用户必须登录
2. 清空操作需要二次确认，避免误操作
3. 清空后购物车为空

#### 用户操作流程
1. 用户点击"清空购物车"按钮
2. 弹出确认对话框："确定要清空购物车吗？"
3. 用户确认后，清空所有商品
4. 清空成功后，显示空购物车提示

---

### 3.6 结算预览

#### 功能描述
用户点击"去结算"时，展示最终需要支付的价格明细，包括商品价格、优惠金额、运费等。

#### 业务规则
1. 用户必须登录
2. 只能选择有库存的商品进行结算
3. 自动过滤失效商品（下架/无库存）
4. 实时计算商品价格（调用商品服务）
5. 实时计算优惠金额（调用促销服务，如有）
6. 展示配送地址和运费信息
7. 展示预计送达时间

#### 展示内容
- **商品列表**：选中的商品信息、数量、单价、小计、优惠金额
- **优惠明细**：
  - 满减优惠（如：满 200 减 30）
  - 优惠券优惠（如：新用户专享券 -20 元）
  - 会员价优惠（如有）
  - 其他促销优惠
- **配送信息**：
  - 配送地址
  - 收货人姓名、电话
  - 运费金额
  - 预计送达时间
- **价格汇总**：
  - 商品总金额
  - 总优惠金额
  - 运费
  - **实付金额**（商品总金额 - 优惠金额 + 运费）

#### 用户操作
- 可以选择部分商品进行结算预览（勾选商品）
- 可以修改配送地址（跳转到地址管理）
- 可以选择优惠券（如有，跳转到优惠券选择）

---

### 3.7 购物车统计

#### 功能描述
获取购物车的基本统计信息，用于在购物车图标上显示商品数量角标。

#### 业务规则
1. 用户必须登录
2. 只统计有效商品（上架且有库存）
3. 实时计算，确保数据准确

#### 统计内容
- **商品总数**：购物车中有效商品的数量（用于角标显示）
- **商品总数量**：所有商品的数量之和
- **商品总金额**：所有商品的小计金额之和
- **是否有失效商品**：用于提示用户清理失效商品

---

### 3.8 跨端购物车合并

#### 功能描述
用户登录后，自动合并未登录时添加的临时购物车（存储在本地/浏览器）。

#### 业务规则
1. 用户登录时自动触发
2. 合并规则：
   - 如果临时购物车中的 SKU 在已登录购物车中已存在，则数量累加（不超过库存上限）
   - 如果临时购物车中的 SKU 在已登录购物车中不存在，则直接添加
3. 合并完成后，清空临时购物车

#### 用户感知
- 用户登录后，购物车自动更新，包含未登录时添加的商品
- 如果合并时出现库存不足等情况，需要提示用户

---

## 4. 业务规则与约束

### 4.1 库存相关规则
1. **加购时**：数量不能超过当前库存
2. **修改数量时**：实时校验库存，不能超过库存上限
3. **查询购物车时**：标记库存不足的商品，但不自动删除
4. **结算预览时**：只计算有库存的商品，失效商品不参与计算

### 4.2 价格相关规则
1. **价格快照**：加购时保存加入时的价格（用于历史记录和争议处理）
2. **实时价格**：查询购物车时显示最新价格（调用商品服务）
3. **价格变化**：如果商品价格发生变化，不自动更新购物车，用户需要手动刷新或重新加购
4. **结算价格**：结算时使用最新价格，确保用户支付的是当前价格

### 4.3 商品状态处理
1. **商品下架**：购物车中的商品如果被下架，标记为失效，不允许结算，但保留在购物车中供用户查看
2. **SKU 下架**：购物车中的 SKU 如果被下架，标记为失效，不允许结算
3. **库存为 0**：购物车中的商品如果库存变为 0，标记为失效，不允许结算
4. **失效商品展示**：失效商品在购物车中显示，但置灰处理，并提示失效原因，引导用户删除

### 4.4 数量限制
1. **单个商品数量**：1 - 库存上限
2. **购物车商品总数**：不超过 100 个（可配置，防止购物车过大影响性能）
3. **单个 SKU 数量**：不能超过该 SKU 的库存上限

### 4.5 数据同步规则
1. **跨端同步**：用户在不同设备登录后，购物车数据自动同步
2. **实时性**：购物车操作（加购、修改、删除）后，所有端的数据实时更新
3. **冲突处理**：如果用户在多个端同时操作，以最后操作为准（或采用更复杂的合并策略）

---

## 5. 异常场景处理

### 5.1 商品下架
**场景**：用户购物车中的商品被商家下架了

**处理方式**：
- 商品在购物车中保留，但标记为"已下架"
- 商品置灰显示，并提示"该商品已下架"
- 不允许结算，提示用户删除该商品
- 用户可以手动删除失效商品

### 5.2 库存不足
**场景**：用户购物车中的商品数量超过了当前库存

**处理方式**：
- 修改数量时，如果超过库存，自动调整为最大库存数
- 提示用户"库存不足，已调整为最大可购买数量"
- 查询购物车时，标记库存不足的商品
- 结算预览时，只计算有库存的商品

### 5.3 价格变化
**场景**：商品价格发生变化（涨价或降价）

**处理方式**：
- 查询购物车时，显示最新价格
- 如果价格下降，用户受益；如果价格上涨，提示用户价格已变化
- 结算时使用最新价格，确保公平
- 保留加购时的价格快照，用于历史记录

### 5.4 服务异常
**场景**：商品服务或促销服务暂时不可用

**处理方式**：
- 使用缓存的价格快照，保证基本功能可用
- 提示用户"价格信息可能不是最新的，请稍后刷新"
- 优惠信息暂不展示，但不影响加购、删除等基本操作
- 服务恢复后，自动更新价格和优惠信息

### 5.5 并发操作
**场景**：用户在多个设备同时操作购物车

**处理方式**：
- 采用最后写入优先的策略（或更复杂的合并策略）
- 关键操作（如加购、删除）使用锁机制，防止数据冲突
- 操作后实时同步到所有端

---

## 6. 用户体验要求

### 6.1 操作便捷性
- 加购操作简单，一键完成
- 修改数量方便，支持快速增减
- 删除操作简单，支持批量删除
- 结算预览清晰，价格明细一目了然

### 6.2 信息展示
- 商品信息完整准确（图片、名称、规格、价格）
- 库存状态清晰（有库存/库存不足/无库存）
- 优惠信息突出（如有促销、会员价等）
- 失效商品明确标识（置灰、提示原因）

### 6.3 反馈及时性
- 操作后立即反馈（成功/失败提示）
- 价格变化实时更新
- 库存变化实时校验
- 数据同步及时准确

### 6.4 错误提示
- 错误提示明确，告诉用户具体原因
- 提供解决建议（如：库存不足时提示最大可购买数量）
- 避免技术性错误信息，使用用户能理解的语言

---

## 7. 性能与可用性要求

### 7.1 响应速度
- 加购操作：用户点击后 1 秒内看到结果
- 查询购物车：页面加载 2 秒内显示内容
- 修改数量：操作后立即更新，无延迟感
- 结算预览：3 秒内展示完整信息

### 7.2 并发支持
- 支持大促场景：单用户频繁操作购物车
- 支持高并发：多用户同时操作购物车
- 系统稳定：高并发下不出现数据错误

### 7.3 数据一致性
- 跨端数据同步及时准确
- 价格和库存信息实时更新
- 操作结果准确可靠

### 7.4 容错能力
- 商品服务异常时，基本功能可用
- 促销服务异常时，不影响加购、删除等操作
- 网络异常时，有友好的错误提示

---

## 8. 后续优化方向

### 8.1 功能扩展
- 购物车商品过期自动清理（如 30 天未操作自动删除）
- 购物车商品推荐（基于用户浏览历史推荐相似商品）
- 购物车限时特价提醒（商品降价时通知用户）
- 购物车分享功能（分享购物车给好友）
- 购物车商品收藏功能（将购物车商品转为收藏）

### 8.2 体验优化
- 购物车商品排序（按价格、添加时间等）
- 购物车商品分组（按店铺、类目等）
- 购物车商品备注（用户可添加备注信息）
- 购物车商品对比功能

### 8.3 营销功能
- 购物车商品凑单提醒（如：再买 X 元可享受满减）
- 购物车商品优惠券推荐
- 购物车商品限时特价提醒

---

## 9. 验收标准

### 9.1 功能验收
- [ ] 用户可以成功添加商品到购物车
- [ ] 用户可以查看购物车列表，信息准确完整
- [ ] 用户可以修改购物车商品数量
- [ ] 用户可以删除购物车商品（单个/批量）
- [ ] 用户可以查看结算预览，价格计算准确
- [ ] 跨端购物车数据同步正常
- [ ] 失效商品正确标识和处理

### 9.2 体验验收
- [ ] 操作响应迅速，无卡顿感
- [ ] 错误提示明确，用户能理解
- [ ] 信息展示清晰，易于理解
- [ ] 跨端同步及时，数据一致

### 9.3 异常验收
- [ ] 商品下架后，购物车中正确标记为失效
- [ ] 库存不足时，正确提示用户并限制数量
- [ ] 价格变化时，正确显示最新价格
- [ ] 服务异常时，基本功能可用

---

**文档版本**：v1.0  
**编写日期**：2024-01-15  
**编写人**：产品经理

