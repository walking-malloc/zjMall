# 用户服务产品需求文档（PRD）

## 1. 服务概述

### 1.1 服务定位
用户服务是电商平台的基础服务之一，负责用户账号管理、身份认证、用户信息维护、收货地址管理等核心功能。作为平台的基础服务，为订单、购物车、评价等业务服务提供用户身份和基础信息支撑。

### 1.2 服务目标
- **用户注册与登录**：支持多种注册登录方式，提供安全便捷的身份认证
- **用户信息管理**：维护用户基本信息、偏好设置、账号安全状态
- **收货地址管理**：支持用户管理多个收货地址，支持地址的增删改查和默认地址设置
- **账号安全**：提供密码修改、手机号绑定/解绑、账号状态管理等功能
- **多端支持**：支持用户在PC、H5、小程序、APP等多端登录，统一账号体系

### 1.3 服务边界
**包含的功能：**
- 用户注册、登录、登出
- 用户基本信息查询与更新
- 收货地址的完整生命周期管理
- 账号安全相关操作（密码修改、手机号绑定等）
- 用户状态查询（是否实名、是否被封禁等）


---

## 2. 用户角色与使用场景

### 2.1 主要用户角色
- **C端用户**：普通消费者，使用平台进行购物
- **平台运营**：需要查看用户数据、管理用户状态（如封禁/解封）
- **客服**：需要查询用户信息协助处理售后问题

### 2.2 典型使用场景

**场景1：新用户注册**
- 用户通过手机号注册账号
- 输入手机号、验证码、设置密码
- 注册成功后自动登录，进入首页

**场景2：用户登录**
- 已注册用户通过手机号+密码或手机号+验证码登录
- 登录成功后获得访问令牌（Token），用于后续请求的身份验证
- 支持"记住我"功能，Token有效期延长

**场景3：查看/编辑个人信息**
- 用户查看自己的昵称、头像、手机号、邮箱等信息
- 可以修改昵称、头像、邮箱等非敏感信息
- 修改手机号需要验证码验证

**场景4：管理收货地址**
- 用户添加新的收货地址（姓名、手机号、省市区、详细地址、邮编）
- 可以设置默认收货地址
- 可以编辑或删除已有地址
- 下单时从地址列表中选择收货地址

**场景5：账号安全**
- 用户修改登录密码（需要验证旧密码）
- 用户绑定/解绑手机号（需要验证码）
- 用户查看登录历史（可选功能）

---

## 3. 功能需求详述

### 3.1 用户注册

#### 3.1.1 手机号注册
**功能描述：**
用户通过手机号和验证码完成注册，注册时需要设置登录密码。

**输入：**
- 手机号（11位，需格式校验）
- 短信验证码（6位数字）
- 登录密码（8-20位，需包含字母和数字）
- 确认密码（需与登录密码一致）

**业务规则：**
- 手机号不能重复注册（已存在则提示"该手机号已注册"）
- 验证码有效期5分钟，验证码错误3次后需重新获取
- 密码需符合复杂度要求，注册时需用户同意《用户协议》和《隐私政策》
- 注册成功后自动创建用户账号，初始状态为"正常"，自动完成首次登录

**输出：**
- 注册成功：返回用户基本信息（用户ID、昵称、手机号）和登录Token
- 注册失败：返回具体错误原因（手机号已注册、验证码错误、密码不符合要求等）

#### 3.1.2 第三方登录（预留，首期可暂不实现）
- 支持微信、支付宝等第三方账号登录
- 首次登录时自动创建账号并绑定第三方账号
- 已绑定账号的用户可直接登录

### 3.2 用户登录

#### 3.2.1 手机号+密码登录
**功能描述：**
已注册用户通过手机号和密码登录。

**输入：**
- 手机号
- 登录密码

**业务规则：**
- 密码错误5次后账号临时锁定30分钟
- 登录成功后生成Token，默认有效期7天
- 支持"记住我"选项，选择后Token有效期延长至30天
- 记录登录时间、IP地址、设备信息（用于安全审计）

**输出：**
- 登录成功：返回用户基本信息、Token、Token过期时间
- 登录失败：返回错误原因（账号不存在、密码错误、账号被锁定等）

#### 3.2.2 手机号+验证码登录
**功能描述：**
用户通过手机号和短信验证码快速登录，无需输入密码。

**输入：**
- 手机号
- 短信验证码

**业务规则：**
- 验证码有效期5分钟
- 如果手机号未注册，提示用户先注册
- 登录成功后生成Token，有效期7天

**输出：**
- 登录成功：返回用户信息和Token
- 登录失败：返回错误原因（验证码错误、手机号未注册等）

#### 3.2.3 登出
**功能描述：**
用户主动登出，使当前Token失效。

**业务规则：**
- 登出后Token立即失效，无法再使用该Token访问需要登录的接口
- 支持多端登录时，只登出当前端，其他端不受影响

### 3.3 用户信息管理

#### 3.3.1 查询用户信息
**功能描述：**
用户查询自己的基本信息，或其他服务查询用户信息（需权限校验）。

**返回信息：**
- 用户ID（唯一标识）
- 昵称
- 头像URL
- 手机号（部分脱敏显示，如：138****5678）
- 邮箱（如有）
- 性别（男/女/未设置）
- 生日（如有）
- 注册时间
- 账号状态（正常/已锁定/已注销）

**业务规则：**
- 用户只能查询自己的完整信息
- 其他服务查询用户信息时，只能获取必要的字段（如用户ID、昵称、手机号）
- 敏感信息（如完整手机号）需脱敏处理

#### 3.3.2 更新用户信息
**功能描述：**
用户修改自己的基本信息。

**可修改字段：**
- 昵称（2-20个字符，不能包含敏感词）
- 头像（上传图片URL）
- 邮箱
- 性别
- 生日

**业务规则：**
- 昵称修改后需审核（可选，首期可暂不实现审核）
- 手机号修改需要通过"手机号绑定"功能，不能直接修改
- 用户ID、注册时间等系统字段不可修改

#### 3.3.3 用户状态查询
**功能描述：**
查询用户账号状态，供其他服务调用（如订单服务下单前校验用户状态）。

**返回状态：**
- 正常：用户可以正常使用平台功能
- 已锁定：用户因违规操作被临时锁定，无法下单
- 已注销：用户主动注销账号，账号数据保留但不可用

### 3.4 收货地址管理

#### 3.4.1 添加收货地址
**功能描述：**
用户添加新的收货地址。

**输入字段：**
- 收货人姓名（必填，2-20个字符）
- 收货人手机号（必填，11位，需格式校验）
- 所在省份（必填）
- 所在城市（必填）
- 所在区县（必填）
- 详细地址（必填，5-200个字符）
- 邮政编码（可选，6位数字）
- 是否设为默认地址（可选，默认否）

**业务规则：**
- 每个用户最多可添加20个收货地址
- 如果用户没有默认地址，新添加的第一个地址自动设为默认
- 如果新地址设为默认，原默认地址自动取消默认状态
- 地址信息需做基础校验（如手机号格式、地址长度等）

**输出：**
- 添加成功：返回地址ID和完整地址信息
- 添加失败：返回错误原因（地址数量超限、信息格式错误等）

#### 3.4.2 查询收货地址列表
**功能描述：**
用户查询自己的所有收货地址。

**返回信息：**
- 地址列表（按创建时间倒序）
- 每个地址包含：地址ID、收货人信息、完整地址、是否默认、创建时间

**业务规则：**
- 默认地址排在列表第一位
- 如果用户没有地址，返回空列表

#### 3.4.3 查询单个收货地址
**功能描述：**
根据地址ID查询地址详情。

**业务规则：**
- 用户只能查询自己的地址
- 地址不存在或不属于当前用户时返回错误

#### 3.4.4 更新收货地址
**功能描述：**
用户修改已有收货地址的信息。

**业务规则：**
- 可修改所有字段（同添加地址的字段）
- 如果修改后的地址设为默认，原默认地址自动取消默认
- 地址ID不可修改

#### 3.4.5 删除收货地址
**功能描述：**
用户删除不需要的收货地址。

**业务规则：**
- 用户只能删除自己的地址
- 如果删除的是默认地址，系统自动将最早创建的地址设为默认（如有）
- 如果删除后用户没有地址了，下单时需要提示用户先添加地址

#### 3.4.6 设置默认地址
**功能描述：**
用户将某个地址设为默认收货地址。

**业务规则：**
- 设置新默认地址后，原默认地址自动取消默认状态
- 默认地址在下单时自动选中，用户可手动切换

### 3.5 账号安全

#### 3.5.1 修改密码
**功能描述：**
用户修改登录密码。

**输入：**
- 旧密码（必填，用于验证身份）
- 新密码（必填，8-20位，需包含字母和数字）
- 确认新密码（必填，需与新密码一致）

**业务规则：**
- 必须验证旧密码正确才能修改
- 新密码不能与旧密码相同
- 密码修改成功后，建议用户重新登录（可选，可让当前Token失效）

#### 3.5.2 绑定手机号
**功能描述：**
用户为账号绑定手机号（注册时已绑定，此功能用于更换手机号）。

**输入：**
- 新手机号
- 新手机号的验证码
- 旧手机号的验证码（用于验证身份）

**业务规则：**
- 新手机号不能已被其他账号使用
- 验证码有效期5分钟
- 绑定成功后，旧手机号自动解绑

#### 3.5.3 解绑手机号（可选，首期可暂不实现）
**功能描述：**
用户解绑手机号（需确保账号有其他登录方式，如邮箱+密码）。

#### 3.5.4 查看登录历史（可选，首期可暂不实现）
**功能描述：**
用户查看最近30天的登录记录。

**返回信息：**
- 登录时间
- 登录IP地址
- 登录设备（浏览器/APP名称）
- 登录地点（根据IP解析，可选）

---

## 4. 业务规则汇总

### 4.1 账号规则
- 一个手机号只能注册一个账号
- 账号状态包括：正常、已锁定、已注销
- 账号被锁定后，用户无法登录和下单，需联系客服解锁
- 账号注销后，用户数据保留但账号不可用（符合数据保留要求）

### 4.2 密码规则
- 密码长度：8-20位
- 密码复杂度：需包含字母和数字，建议包含特殊字符
- 密码错误5次后账号临时锁定30分钟
- 密码修改需验证旧密码

### 4.3 验证码规则
- 短信验证码：6位数字，有效期5分钟
- 验证码错误3次后需重新获取
- 同一手机号60秒内只能获取一次验证码（防刷）

### 4.4 地址规则
- 每个用户最多20个收货地址
- 必须有一个默认地址（如没有，系统自动设置）
- 地址信息需做格式校验（手机号、地址长度等）

### 4.5 Token规则
- Token默认有效期7天
- "记住我"选项可将Token有效期延长至30天
- Token失效后需重新登录
- 登出后Token立即失效

---

## 6. 数据概念（不涉及具体表结构）

### 6.1 用户核心数据
- **用户ID**：唯一标识，系统生成
- **手机号**：登录账号，唯一
- **密码**：加密存储（如bcrypt）
- **昵称**：用户显示名称
- **头像**：头像图片URL
- **邮箱**：可选
- **性别**：男/女/未设置
- **生日**：可选
- **注册时间**：账号创建时间
- **账号状态**：正常/已锁定/已注销
- **最后登录时间**：用于安全审计

### 6.2 收货地址数据
- **地址ID**：唯一标识
- **用户ID**：关联用户
- **收货人姓名**：必填
- **收货人手机号**：必填
- **省份/城市/区县**：三级地址
- **详细地址**：街道门牌号
- **邮政编码**：可选
- **是否默认**：布尔值
- **创建时间/更新时间**：时间戳

### 6.3 登录会话数据（可选，用于多端管理）
- **Token**：访问令牌
- **用户ID**：关联用户
- **设备信息**：登录设备标识
- **IP地址**：登录IP
- **创建时间/过期时间**：Token有效期

---

## 7. 与其他服务的关系

### 7.1 被依赖关系
- **订单服务**：下单时需要查询用户信息和收货地址，校验用户状态
- **购物车服务**：购物车数据与用户ID关联
- **评价服务**：评价与用户ID关联
- **网关服务**：网关需要调用用户服务进行Token校验和用户身份验证

### 7.2 依赖关系
- **短信服务**：发送注册/登录验证码（可选，首期可用Mock）
- **文件服务**：上传用户头像（可选，首期可用OSS或本地存储）

### 7.3 事件发布（可选，后续扩展）
- 用户注册成功事件：供其他服务订阅（如发放新人优惠券）
- 用户状态变更事件：账号锁定/解锁时通知相关服务

---

## 8. 非功能需求

### 8.1 性能要求
- 用户信息查询接口：P95响应时间 < 100ms
- 地址列表查询：P95响应时间 < 150ms
- 登录接口：P95响应时间 < 500ms（包含验证码校验）

### 8.2 可用性要求
- 服务可用性：99.9%（年度故障时间 < 8.76小时）
- 登录功能为核心功能，需优先保障可用性

### 8.3 安全要求
- 密码需加密存储，不能明文保存
- Token需安全传输（HTTPS），防止被截获
- 接口需做防刷限制（如验证码获取频率限制）
- 敏感操作（如修改密码、绑定手机号）需二次验证

### 8.4 扩展性要求
- 支持用户量级：百万级用户（首期）
- 预留支持千万级用户的扩展能力（分库分表、缓存策略）

---

## 9. 首期实现范围（MVP）

### 9.1 必须实现（核心功能）
- ✅ 手机号注册
- ✅ 手机号+密码登录
- ✅ 手机号+验证码登录
- ✅ 查询/更新用户信息
- ✅ 收货地址的完整CRUD
- ✅ 设置默认地址
- ✅ 修改密码
- ✅ 用户状态查询

### 9.2 可选实现（后续迭代）
- ⏳ 第三方登录（微信、支付宝）
- ⏳ 查看登录历史
- ⏳ 解绑手机号
- ⏳ 多端登录管理
- ⏳ 用户注销功能

### 9.3 暂不实现（未来规划）
- 🔮 用户等级/积分（由会员服务负责）
- 🔮 实名认证（由风控服务负责）
- 🔮 用户画像/标签（由数据服务负责）

---

## 10. 验收标准

### 10.1 功能验收
- 用户可以成功注册账号并登录
- 用户可以查看和修改自己的信息
- 用户可以添加、查询、修改、删除收货地址
- 用户可以设置默认收货地址
- 用户可以修改密码
- 其他服务可以查询用户信息和状态

### 10.2 性能验收
- 所有接口响应时间符合非功能需求要求
- 支持并发登录（如100 QPS）

### 10.3 安全验收
- 密码加密存储，不能明文查看
- Token校验机制正常工作
- 防刷限制生效（验证码获取频率限制）

---

## 11. 后续优化方向

### 11.1 功能优化
- 支持更多登录方式（第三方登录、生物识别）
- 用户画像和个性化推荐
- 账号安全增强（设备指纹、异常登录提醒）

### 11.2 性能优化
- 用户信息缓存（Redis）
- 地址列表缓存
- 数据库读写分离

### 11.3 体验优化
- 地址智能识别（根据手机号自动填充）
- 地址快速选择（常用地址优先显示）
- 登录状态持久化优化

---

**文档版本：** v1.0  
**最后更新：** 2024-12-10  
**文档维护：** 产品团队

