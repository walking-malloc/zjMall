# 电商 B2C 微服务版需求文档（按服务拆分）

## 1. 背景与目标
- 面向 B2C 零售，支持实物/虚拟商品，PC/H5/小程序/APP 通用。
- 目标：完成“浏览→下单→支付→履约→售后”闭环，预留大促扩展（限流、降级、秒杀隔离）。
- 非目标（首期不做）：多商户入驻/分账、跨境多币种、内容社区化。

## 2. 角色与用户故事
- C 端用户：浏览/搜索、加购、下单、支付、查物流、退换货、评价。
- 运营：商品/类目维护，价格与促销配置，券发放，运营位管理，黑白名单与限购策略。
- 仓储/履约：拣货、发货、异常上报、逆向物流。
- 客服：售前答疑、售后仲裁。
- 财务：对账、退款审核（自动+人工）、发票。

## 3. 服务拆分与职责
### 3.1 网关服务（API Gateway）
- 职责：统一入口、路由、鉴权、限流/熔断、灰度发布、签名校验、跨域。
- 接口：对外 REST/HTTP，对内 gRPC/HTTP；暴露健康检查与监控指标。
- 依赖：注册发现、鉴权服务、限流组件。

### 3.2 用户/账号服务
- 职责：注册登录（短信/密码/三方预留）、会话/Token、账号安全、多端登录管理、地址簿、实名状态预留。
- 接口：用户 CRUD、登录/刷新 Token、地址簿 CRUD、用户状态查询。
- 数据：用户表、地址表、登录历史（可选）、设备指纹（可选）。

### 3.3 商品服务
- 职责：SPU/SKU、类目、属性、上下架、价格读取、媒体（图/视频）、库存展示（与库存服务联动）。
- 接口：商品详情、SKU 列表、价格查询、上下架管理、类目/属性管理。
- 数据：SPU/SKU/价格/类目/属性表，媒体资源位。

### 3.4 搜索服务
- 职责：商品索引构建与检索，分词、联想、纠错，结果排序与过滤。
- 接口：搜索、联想、热门榜单。
- 数据：搜索索引（ES/Meilisearch 等），与商品服务保持索引同步。

### 3.5 购物车服务
- 职责：加购、数量变更、删除、跨端合并、实时价促试算（调用促销/商品）。
- 接口：添加/查询/删除/更新购物车，结算预览。
- 数据：购物车项（用户维度），可放缓存。

### 3.6 促销与优惠券服务
- 职责：满减/满折/直降/限时折扣、优惠券（平台/店铺）、会员价、叠加与优先级规则，限购策略。
- 接口：促销查询、券领取、券核销/回滚、结算优惠计算。
- 数据：促销规则表、券模板/实例表、限购/黑白名单。

### 3.7 订单服务
- 职责：下单校验、价格/优惠重算、库存预占请求、订单创建、拆单（按仓/商家预留）、订单状态机（待支付→待发货→待收货→完成/关闭）、超时取消、补单。
- 接口：创建订单、查询订单、取消订单、订单列表、订单状态回调处理。
- 数据：订单主/子/包裹、支付单关联、发票信息、订单日志。

### 3.8 库存服务
- 职责：库存查询、预占/解占、扣减、防超卖、库存锁粒度（仓-商品-SKU），安全库存告警。
- 接口：库存校验、预占、解占、扣减、库存调整。
- 数据：库存表/批次表，锁记录（幂等键）。

### 3.9 支付服务
- 职责：支付单生成、收银台聚合、支付渠道（支付宝/微信/余额）对接、回调校验、支付超时取消、对账、退款（与售后协同）。
- 接口：发起支付、支付回调、查询支付单、退款申请、退款回调。
- 数据：支付单、对账记录、退款单（与售后共享或关联）。

### 3.10 履约/物流服务
- 职责：仓配分单（就近仓/优先仓）、出库、揽收、运单绑定、轨迹同步、签收确认、异常签收/拒收。
- 接口：创建包裹、绑定运单、推送/查询物流轨迹、签收确认。
- 数据：包裹、运单、轨迹记录、异常记录。

### 3.11 售后服务
- 职责：退货退款/仅退款/换货，举证上传，审核（自动+人工），逆向物流，退款原路退回。
- 接口：售后申请、审核、进度查询、退款结果回调。
- 数据：售后单、退款单、逆向物流单、审核记录。

### 3.12 评价服务
- 职责：评价/追评/晒图、举报、敏感词/违规审核。
- 接口：提交评价、追评、查询商品评价列表、举报。
- 数据：评价表、举报记录、审核记录。

### 3.13 运营配置服务
- 职责：运营位/轮播/频道配置，公告，黑白名单/限购策略，活动配置（与促销联动）。
- 接口：运营位 CRUD、公告管理、黑白名单管理。
- 数据：运营位配置、公告、名单与策略。

### 3.14 平台基础服务（跨域）
- 鉴权与网关协同：JWT/Session、签名校验、权限控制。
- 配置/注册中心：服务发现、动态配置。
- 消息与事件：订单/支付/库存/售后等事件总线（MQ）。
- 观测性：Tracing/Metrics/Logging，SLO/告警。
- 限流熔断：策略与控制台，热点/秒杀隔离。
- 分布式事务（按需）：Outbox/本地消息表，TCC/Saga（可选 DTM/Seata-Go）。

## 4. 核心业务流程（概述）
1) 浏览/搜索 → 商品详情 → 加购/结算预览（价促试算）。  
2) 下单：校验地址/库存/价格/促销 → 库存预占 → 生成订单（待支付）。  
3) 支付：生成支付单 → 跳转渠道 → 回调校验 → 订单支付成功 → 扣减库存 → 进入待发货。  
4) 履约：仓配分单 → 出库 → 运单绑定 → 物流轨迹 → 签收 → 订单完成。  
5) 售后：在时限内申请 → 审核 → 逆向物流/退款 → 关闭或完成售后。  
6) 评价：订单完成后评价/追评 → 审核 → 展示。  

## 5. 关键业务规则
- 库存防超卖：预占+超时解占，支付成功后扣减；幂等等幂键。  
- 价格锁定与重算：下单时重算为准；优惠叠加顺序明确（直降→满减/满折→券→积分/余额）。  
- 限购与风控：按用户/设备/IP/黑白名单；秒杀/热点隔离。  
- 订单超时：待支付超时自动取消（解占库存）；长时间未发货提醒。  
- 售后时限：签收后 N 天内可申请；退款原路退回。  
- 评价：仅已完成订单可评，追评一次，违规拦截。  

## 6. 非功能需求
- 性能：日常 P95 < 300ms，P99 < 800ms；按目标 QPS 分档容量规划。  
- 可用性：核心链路 99.9%+；支付/订单/库存高可用部署。  
- 弹性：缓存+限流+熔断+降级，读降级兜底，写限流隔离。  
- 观测性：全链路追踪、指标、结构化日志，核心告警（下单/支付成功率、库存扣减失败率）。  
- 安全/合规：敏感信息脱敏，访问控制与审计。  

## 7. 事件与接口（概念级）
- 事件（MQ）：订单创建、支付成功、库存扣减失败、订单超时取消、发货、签收、售后状态变更、优惠券核销、积分变更。  
- 典型接口（REST/gRPC 概念）：  
  - 商品：`GET /products/{id}` `GET /products?query=`  
  - 购物车：`POST /cart/items` `GET /cart` `POST /cart/checkout-preview`  
  - 下单：`POST /orders/prepare`（校验/预占）`POST /orders`（确认）  
  - 支付：`POST /payments` `POST /payments/{id}/callbacks`  
  - 库存：`POST /inventory/reserve` `POST /inventory/release` `POST /inventory/commit`  
  - 履约：`GET /orders/{id}/packages` `GET /logistics/{waybill}`  
  - 售后：`POST /aftersales` `GET /aftersales/{id}`  
  - 促销/券：`GET /promotions` `POST /coupons/claim` `POST /coupons/validate`  
  - 评价：`POST /orders/{id}/reviews` `GET /products/{id}/reviews`

