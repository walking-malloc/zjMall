## 支付服务 PRD（Payment Service）

### 1. 背景与目标

#### 1.1 背景

当前系统已具备用户、商品、购物车、订单、库存等核心能力，用户完成下单后需要支付环节来完成交易闭环。支付是电商平台的核心交易环节，涉及资金流转，需要确保：

- **资金安全**：支付流程必须安全可靠，防止资金损失和重复支付。
- **支付渠道对接**：需要对接主流支付渠道（微信支付、支付宝等），提供统一的支付接口。
- **支付状态管理**：准确跟踪支付状态，处理支付超时、失败、退款等场景。
- **幂等性保障**：支付回调可能重复，需要保证幂等处理，避免重复扣款或重复通知订单服务。
- **可追溯性**：所有支付操作需要完整记录，便于对账、审计和问题排查。

#### 1.2 目标

设计并实现一个**支付服务（payment-service）**，提供独立的支付中心能力，主要目标：

- 为订单生成支付单，支持多种支付渠道（微信支付、支付宝等）。
- 提供统一的支付接口，屏蔽不同支付渠道的差异。
- 安全处理第三方支付回调，校验签名和金额，确保支付结果准确。
- 管理支付单生命周期（创建→支付中→成功/失败/超时关闭）。
- 支持支付超时自动关闭，释放订单库存。
- 与订单服务解耦，通过 **gRPC + MQ** 协作完成支付状态同步。
- 预留退款能力，支持与售后服务协同处理退款。

---

### 2. 术语与概念

- **支付单（Payment）**：为订单创建的支付记录，一个订单对应一个支付单（支持部分支付场景可扩展为多个）。
- **支付单号（payment_no）**：支付单的唯一标识，用于查询和回调。
- **订单号（order_no）**：关联的订单号，一个订单对应一个支付单。
- **支付渠道（pay_channel）**：支付方式，如微信支付、支付宝、余额支付等。
- **第三方交易号（trade_no）**：第三方支付平台返回的交易流水号。
- **支付状态（status）**：
  - `待支付（PENDING）`：支付单已创建，等待用户支付。
  - `支付中（PROCESSING）`：用户已发起支付，等待第三方回调确认。
  - `支付成功（SUCCESS）`：第三方确认支付成功。
  - `支付失败（FAILED）`：支付失败（如余额不足、密码错误等）。
  - `已关闭（CLOSED）`：支付超时或用户取消，支付单关闭。
  - `已退款（REFUNDED）`：支付单已退款（与售后协同）。
- **支付回调（Callback）**：第三方支付平台在支付完成后，主动通知平台的接口。
- **支付超时**：支付单创建后，在规定时间内（如 30 分钟）未完成支付，自动关闭。

---

### 3. 业务范围与不做的事情

#### 3.1 本期范围（v1）

- **支付单管理**：
  - 创建支付单（关联订单号、用户、金额、支付渠道）。
  - 查询支付单详情和状态。
  - 支付单超时自动关闭。
- **支付渠道对接**：
  - 微信支付（H5/小程序/APP，首期可先实现 H5）。
  - 支付宝（H5/APP，首期可先实现 H5）。
  - 余额支付（预留接口，暂不实现）。
- **支付流程**：
  - 创建支付单后返回支付跳转 URL 或支付参数。
  - 接收第三方支付回调，校验签名和金额。
  - 支付成功后通知订单服务（通过 gRPC 或 MQ）。
- **支付状态查询**：
  - 提供支付状态查询接口，供前端轮询或订单服务查询。
  - 支持主动查询第三方支付状态（用于对账和异常处理）。
- **支付日志**：
  - 记录支付单创建、状态变更、回调处理等关键操作日志。

#### 3.2 非本期范围（后续演进）

- **退款功能**：退款申请、退款审核、退款回调处理（与售后服务协同实现）。
- **分账功能**：多商户分账、平台抽成等。
- **支付方式扩展**：银行卡支付、数字人民币、其他第三方支付渠道。
- **支付安全增强**：风控规则、支付限额、异常支付检测。
- **对账功能**：与第三方支付平台对账、自动对账、差异处理。
- **支付统计报表**：支付成功率、渠道分布、退款率等统计。

---

### 4. 业务流程

#### 4.1 创建支付单流程

1. 用户在订单确认页选择支付方式（微信支付/支付宝），点击「去支付」。
2. 前端调用订单服务或支付服务的「创建支付单」接口，传入：
   - 订单号
   - 支付渠道（微信/支付宝）
   - 返回地址（支付成功后的跳转地址，可选）
3. 支付服务：
   - 校验订单是否存在且状态为「待支付」。
   - 校验订单金额是否合法（大于 0）。
   - 生成支付单号（唯一标识）。
   - 调用第三方支付渠道接口，创建支付订单。
   - 保存支付单记录，状态为「待支付」。
   - 设置支付单过期时间（如创建后 30 分钟）。
4. 返回支付跳转 URL（H5）或支付参数（小程序/APP），前端引导用户完成支付。

#### 4.2 支付回调处理流程

1. 用户在第三方支付平台完成支付（输入密码、确认支付等）。
2. 第三方支付平台向支付服务的回调接口发送支付结果通知：
   - 支付单号（或订单号）
   - 第三方交易号
   - 支付金额
   - 支付状态（成功/失败）
   - 签名（用于校验）
3. 支付服务处理回调：
   - **签名校验**：验证回调请求的签名，防止伪造。
   - **金额校验**：验证支付金额是否与订单金额一致。
   - **幂等性校验**：检查该支付单是否已处理过（根据支付单号 + 状态）。
   - **状态更新**：更新支付单状态为「支付成功」或「支付失败」，记录第三方交易号和支付时间。
4. 支付成功后：
   - 通过 gRPC 或 MQ 通知订单服务支付成功。
   - 发送「支付成功」事件到消息队列，供其他服务订阅。
5. 返回处理结果给第三方平台（成功/失败），第三方平台会重试直到收到成功响应。

#### 4.3 支付超时关闭流程

1. 定时任务扫描「待支付」状态的支付单。
2. 检查支付单的过期时间，如果已过期：
   - 更新支付单状态为「已关闭」。
   - 通过 gRPC 或 MQ 通知订单服务支付超时。
   - 订单服务收到通知后，将订单状态更新为「已关闭」，并释放库存预占。
3. 可选：主动查询第三方支付状态，确认是否真的未支付（防止回调丢失）。

#### 4.4 支付状态查询流程

1. 前端或订单服务调用「查询支付状态」接口，传入支付单号。
2. 支付服务：
   - 查询本地支付单状态。
   - 可选：如果状态为「待支付」或「支付中」，主动查询第三方支付状态（用于对账和异常处理）。
3. 返回当前支付状态和第三方交易号。

---

### 5. 功能需求

#### 5.1 创建支付单（必做）

**gRPC 接口**：`CreatePayment`

**输入**：
- `order_no`：订单号（必填）
- `pay_channel`：支付渠道（微信/支付宝，必填）
- `return_url`：支付成功返回地址（可选）

**处理逻辑**：
1. 校验订单是否存在且状态为「待支付」（调用订单服务或从订单服务传入订单信息）。
2. 校验订单金额是否合法（> 0）。
3. 生成支付单号（唯一标识，建议使用雪花 ID 或时间戳 + 随机数）。
4. 调用第三方支付渠道接口创建支付订单：
   - 微信支付：调用统一下单接口，获取 `prepay_id` 或支付 URL。
   - 支付宝：调用统一收单接口，获取支付 URL 或支付参数。
5. 保存支付单记录：
   - 支付单号、订单号、用户 ID、金额、支付渠道
   - 状态：`待支付`
   - 过期时间：当前时间 + 30 分钟（可配置）
   - 回调地址、返回地址
6. 返回支付跳转信息：
   - H5：返回支付 URL，前端跳转。
   - 小程序/APP：返回支付参数（如微信的 `timeStamp`、`nonceStr`、`package`、`signType`、`paySign`），前端调起支付。

**异常处理**：
- 订单不存在或状态不正确：返回错误「订单状态异常，无法支付」。
- 订单金额为 0：返回错误「订单金额异常」。
- 第三方支付接口调用失败：记录日志，返回错误「支付渠道暂时不可用，请稍后重试」。
- 支付单创建失败：记录日志，返回错误「创建支付单失败」。

#### 5.2 支付回调处理（必做）

**gRPC/HTTP 接口**：`PaymentCallback`

**输入**：
- `pay_channel`：支付渠道（用于路由到对应的回调处理逻辑）
- `payment_no`：支付单号（或订单号）
- `trade_no`：第三方交易号
- `amount`：支付金额
- `status`：支付状态（第三方返回）
- `sign`：签名
- `extra_params`：其他参数（不同渠道可能有不同字段）

**处理逻辑**：
1. **签名校验**：
   - 根据支付渠道使用对应的签名算法（如微信的 MD5/SHA256，支付宝的 RSA）校验签名。
   - 签名校验失败：记录日志，返回错误，拒绝处理。
2. **查询支付单**：
   - 根据支付单号查询支付单记录。
   - 支付单不存在：记录日志，返回错误。
3. **幂等性校验**：
   - 检查支付单当前状态，如果已经是「支付成功」，直接返回成功（幂等处理）。
   - 如果状态是「已关闭」或「已退款」，记录日志，返回成功（避免重复处理）。
4. **金额校验**：
   - 比较回调金额与支付单金额是否一致（允许小额差异，如 0.01 元）。
   - 金额不一致：记录告警日志，返回错误，需要人工介入。
5. **状态更新**：
   - 更新支付单状态为「支付成功」或「支付失败」。
   - 记录第三方交易号、支付时间。
   - 使用乐观锁（version）防止并发更新冲突。
6. **通知订单服务**：
   - 支付成功：通过 gRPC 调用订单服务的「支付成功回调」接口，或发送「支付成功」事件到 MQ。
   - 支付失败：可选通知订单服务（订单服务可记录失败原因）。
7. **返回处理结果**：
   - 处理成功：返回 `success`（第三方平台要求）。
   - 处理失败：返回 `fail`（第三方平台会重试）。

**异常处理**：
- 签名校验失败：记录安全告警日志，返回错误。
- 金额不一致：记录告警日志，返回错误，需要人工对账。
- 状态更新失败（乐观锁冲突）：记录日志，返回错误，等待重试。
- 通知订单服务失败：记录日志，可考虑重试机制或异步处理。

#### 5.3 查询支付单（必做）

**gRPC 接口**：`GetPayment`

**输入**：
- `payment_no`：支付单号

**输出**：
- 支付单详情：支付单号、订单号、用户 ID、金额、支付渠道、状态、第三方交易号、创建时间、支付时间、过期时间等。

**处理逻辑**：
1. 根据支付单号查询支付单记录。
2. 支付单不存在：返回错误「支付单不存在」。
3. 返回支付单详情。

#### 5.4 查询支付状态（必做）

**gRPC 接口**：`QueryPaymentStatus`

**输入**：
- `payment_no`：支付单号

**输出**：
- `status`：支付状态
- `trade_no`：第三方交易号（如有）

**处理逻辑**：
1. 查询本地支付单状态。
2. 可选：如果状态为「待支付」或「支付中」，且距离创建时间超过一定阈值（如 5 分钟），主动查询第三方支付状态（用于对账和异常处理）。
3. 返回当前状态和第三方交易号。

#### 5.5 支付超时关闭（必做）

**实现方式**：定时任务或延迟队列

**处理逻辑**：
1. 定时扫描「待支付」状态的支付单（如每分钟执行一次）。
2. 检查支付单的过期时间，如果 `expired_at < 当前时间`：
   - 更新支付单状态为「已关闭」。
   - 通过 gRPC 或 MQ 通知订单服务支付超时。
   - 记录关闭日志。
3. 可选：在关闭前，主动查询第三方支付状态，确认是否真的未支付（防止回调丢失导致误关闭）。

**异常处理**：
- 状态更新失败：记录日志，下次定时任务重试。
- 通知订单服务失败：记录日志，可考虑重试机制。

#### 5.6 支付日志记录（推荐做）

**需求**：
- 记录支付单创建、状态变更、回调处理等关键操作日志。
- 日志字段：操作类型、支付单号、订单号、用户 ID、操作时间、操作结果、错误信息、第三方交易号等。
- 日志主要用于开发排查、运营对账和审计，短期不提供复杂查询接口，后续可扩展。

---

### 6. 非功能需求

#### 6.1 安全性

- **签名校验**：所有第三方回调必须校验签名，防止伪造和重放攻击。
- **金额校验**：回调金额必须与订单金额一致（允许小额差异），防止金额篡改。
- **幂等性**：支付回调可能重复，必须保证幂等处理，避免重复扣款或重复通知。
- **敏感信息保护**：支付单中的敏感信息（如第三方交易号）需要脱敏处理，日志中不记录完整信息。

#### 6.2 可用性

- **支付服务故障时**：
  - 创建支付单接口应快速失败，返回「支付服务暂时不可用」，避免长时间卡住用户。
  - 支付回调接口应尽量可用，避免第三方重试过多。
- **第三方支付渠道故障时**：
  - 记录日志，返回错误「支付渠道暂时不可用，请稍后重试」。
  - 可考虑降级策略（如微信支付不可用时，提示用户使用支付宝）。

#### 6.3 性能

- **创建支付单**：P95 < 500ms（包含调用第三方接口的时间）。
- **支付回调处理**：P95 < 200ms（快速响应第三方，避免重试）。
- **查询支付状态**：P95 < 100ms（本地查询，不包含主动查询第三方的时间）。
- **数据库索引**：支付单号、订单号、用户 ID 需要建立索引，支持快速查询。

#### 6.4 可观测性

- **日志**：
  - 支付单创建、状态变更、回调处理等关键操作需要记录日志。
  - 支付失败、金额不一致、签名校验失败等异常情况需要记录告警日志。
  - 日志中需要包含 trace-id，便于链路追踪。
- **指标**（可选，后续接入 Prometheus）：
  - 支付单创建 QPS、成功率。
  - 支付回调 QPS、成功率、失败率。
  - 支付超时关闭数量。
  - 各支付渠道的使用分布。

#### 6.5 幂等性保障

- **支付回调幂等**：
  - 使用支付单号 + 状态作为幂等键，相同支付单的重复回调只处理一次。
  - 使用乐观锁（version）防止并发更新冲突。
- **创建支付单幂等**：
  - 同一订单号多次创建支付单，应返回已存在的支付单（或返回错误「支付单已存在」）。

---

### 7. 与现有服务的关系

- **订单服务（order-service）**：
  - 订单服务创建订单后，调用支付服务创建支付单。
  - 支付服务支付成功后，通知订单服务更新订单状态为「待发货」。
  - 支付服务支付超时后，通知订单服务关闭订单并释放库存。
  - 订单服务可查询支付单状态，用于订单详情展示。

- **用户服务（user-service）**：
  - 支付单关联用户 ID，用于查询用户的支付记录（后续扩展）。

- **消息队列（MQ）**：
  - 支付服务发送「支付成功」事件到 MQ，供其他服务订阅（如库存服务、履约服务、营销服务等）。
  - 支付服务发送「支付超时」事件到 MQ，供订单服务订阅。

---

### 8. 数据模型设计

#### 8.1 支付单表（payments）

**字段设计**：
- `id`：主键（雪花 ID 或 ULID）
- `payment_no`：支付单号（唯一索引，用于查询和回调）
- `order_no`：订单号（索引，用于关联订单）
- `user_id`：用户 ID（索引，用于查询用户支付记录）
- `amount`：支付金额（decimal(10,2)，精确到分）
- `pay_channel`：支付渠道（varchar(20)，如 wechat/alipay）
- `status`：支付状态（tinyint，1待支付/2支付中/3成功/4失败/5已关闭/6已退款）
- `trade_no`：第三方交易号（varchar(64)，索引，用于对账）
- `notify_url`：回调地址（varchar(255)，支付服务接收回调的地址）
- `return_url`：返回地址（varchar(255)，支付成功后前端跳转地址）
- `paid_at`：支付时间（timestamp，支付成功时记录）
- `expired_at`：过期时间（timestamp，用于超时关闭）
- `version`：版本号（int，乐观锁，防止并发更新）
- `created_at`：创建时间
- `updated_at`：更新时间

**索引设计**：
- 主键索引：`id`
- 唯一索引：`payment_no`
- 普通索引：`order_no`、`user_id`、`trade_no`、`status`、`expired_at`（用于定时任务扫描）

#### 8.2 支付日志表（payment_logs，可选）

**字段设计**：
- `id`：主键
- `payment_no`：支付单号（索引）
- `order_no`：订单号（索引）
- `action`：操作类型（varchar(20)，如 create/callback/close）
- `status_before`：变更前状态
- `status_after`：变更后状态
- `trade_no`：第三方交易号
- `error_msg`：错误信息（如有）
- `extra_data`：扩展字段（JSON，存储额外信息）
- `created_at`：创建时间

**用途**：
- 审计和排查：记录每次支付单状态变更，便于问题排查。
- 对账：记录支付回调的详细信息，便于与第三方对账。

---

### 9. 第三方支付渠道对接

#### 9.1 微信支付

**接口**：
- 统一下单：`https://api.mch.weixin.qq.com/pay/unifiedorder`
- 查询订单：`https://api.mch.weixin.qq.com/pay/orderquery`
- 支付回调：支付服务提供的回调接口

**支付方式**：
- H5 支付：返回支付 URL，前端跳转。
- 小程序支付：返回支付参数，前端调起 `wx.requestPayment`。
- APP 支付：返回支付参数，APP 调起微信支付 SDK。

**签名算法**：MD5 或 SHA256（推荐 SHA256）

#### 9.2 支付宝

**接口**：
- 统一收单下单：`https://openapi.alipay.com/gateway.do`
- 查询订单：`https://openapi.alipay.com/gateway.do`
- 支付回调：支付服务提供的回调接口

**支付方式**：
- H5 支付：返回支付 URL，前端跳转。
- APP 支付：返回支付参数，APP 调起支付宝 SDK。

**签名算法**：RSA2（推荐）

---

### 10. 里程碑（建议）

- **M1：支付服务雏形**
  - 建表：`payments`、`payment_logs`（可选）。
  - 提供基本 gRPC 接口：创建支付单、查询支付单、查询支付状态。
  - 实现支付超时关闭定时任务。
  - 本地单元测试通过。

- **M2：第三方支付渠道对接**
  - 对接微信支付（H5，优先）。
  - 对接支付宝（H5，优先）。
  - 实现支付回调处理，包括签名校验、金额校验、幂等处理。
  - 打通「创建支付单 → 跳转支付 → 回调处理 → 通知订单服务」的闭环。

- **M3：优化与观测**
  - 增加支付日志记录。
  - 增加支付状态主动查询（用于对账和异常处理）。
  - 增加监控指标和告警。
  - 压测支付回调接口，优化性能。

---

**文档版本**：v1.0  
**编写日期**：2025-01-30  
**编写人**：产品经理

