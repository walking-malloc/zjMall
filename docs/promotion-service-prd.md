# 促销服务产品需求文档（PRD）

## 1. 服务概述

### 1.1 服务定位
促销服务是电商平台的核心营销服务，负责促销活动管理、优惠券管理、优惠计算等核心功能。作为平台的营销引擎，为购物车、订单、商品展示等业务服务提供统一的优惠计算和促销活动支撑。

### 1.2 服务目标
- **促销活动管理**：支持多种促销类型（满减、满折、直降、限时折扣），提供灵活的活动配置和管理能力
- **优惠券体系**：支持优惠券模板创建、用户领取、核销等完整生命周期管理
- **优惠计算引擎**：提供统一的优惠计算接口，支持促销活动与优惠券的叠加计算
- **实时优惠查询**：支持根据商品、类目、订单金额等条件实时查询可用促销活动
- **限购与配额控制**：支持用户限购次数、活动总配额等风控策略

### 1.3 服务边界
**包含的功能：**
- 促销活动的创建、更新、查询、删除
- 优惠券模板的创建和管理
- 用户优惠券的领取、查询、核销
- 可用促销活动的查询和匹配
- 优惠金额的计算（促销优惠 + 优惠券优惠）
- 促销使用记录的记录和统计

**不包含的功能（由其他服务负责）：**
- 商品价格管理（由商品服务负责）
- 订单金额计算（由订单服务负责，但会调用促销服务计算优惠）
- 库存管理（由库存服务负责）
- 会员等级和会员价（由会员服务负责，后续扩展）

---

## 2. 用户角色与使用场景

### 2.1 主要用户角色
- **平台运营**：创建和管理促销活动、优惠券模板，配置促销规则
- **C端用户**：领取优惠券、查看可用促销活动、享受优惠
- **购物车服务**：查询可用促销、计算购物车优惠金额
- **订单服务**：下单时计算最终优惠金额、核销优惠券

### 2.2 典型使用场景

**场景1：运营创建满减活动**
- 运营在后台创建"满200减30"的满减活动
- 设置活动时间、适用商品范围、限购次数等
- 活动生效后，用户在购物车和下单时自动享受优惠

**场景2：用户领取优惠券**
- 用户在优惠券中心看到可领取的优惠券
- 点击领取后，优惠券进入"我的优惠券"
- 下单时可以选择使用该优惠券

**场景3：购物车计算优惠**
- 用户在购物车页面查看商品总价
- 系统自动计算可用促销活动（如满减）
- 显示优惠明细和最终实付金额

**场景4：下单时优惠计算**
- 用户在结算页面选择优惠券
- 系统计算促销优惠 + 优惠券优惠
- 显示最终实付金额，用户确认后下单

**场景5：优惠券核销**
- 用户下单并支付成功后
- 系统自动核销使用的优惠券
- 优惠券状态变为"已使用"，不可再次使用

---

## 3. 功能需求详述

### 3.1 促销活动管理

#### 3.1.1 促销活动类型

**满减活动（FULL_REDUCTION）**
- 功能描述：订单金额满足条件时，直接减免固定金额
- 示例：满200减30、满500减100
- 条件值：满额金额（如：200）
- 优惠值：减免金额（如：30）

**满折活动（FULL_DISCOUNT）**
- 功能描述：订单金额满足条件时，按折扣比例计算优惠
- 示例：满300打8折、满500打7折
- 条件值：满额金额（如：300）
- 优惠值：折扣比例（如：0.8 表示8折）

**直降活动（DIRECT_REDUCTION）**
- 功能描述：指定商品直接降价
- 示例：商品A直降50元
- 条件值：商品ID列表
- 优惠值：降价金额（如：50）

**限时折扣（TIME_LIMITED）**
- 功能描述：指定商品在特定时间段内按折扣价销售
- 示例：商品B限时8折，活动时间：2024-12-20 00:00:00 至 2024-12-25 23:59:59
- 条件值：商品ID列表 + 时间范围
- 优惠值：折扣比例（如：0.8）

#### 3.1.2 创建促销活动

**功能描述：**
运营在后台创建新的促销活动，配置活动规则和适用范围。

**输入字段：**
- 促销名称（必填，2-100字符）
- 促销类型（必填，1-满减，2-满折，3-直降，4-限时折扣）
- 促销描述（可选）
- 适用商品ID列表（可选，空表示全平台）
- 适用类目ID列表（可选）
- 条件值（必填，如：满200）
- 优惠值（必填，如：减30 或 打8折）
- 开始时间（必填）
- 结束时间（必填）
- 每人限用次数（可选，0表示不限制）
- 总配额（可选，0表示不限制）
- 排序权重（可选，用于优先级排序）

**业务规则：**
- 开始时间必须早于结束时间
- 结束时间不能早于当前时间（允许创建未来活动）
- 条件值和优惠值必须符合促销类型的要求
- 如果设置了总配额，已使用配额不能超过总配额
- 创建后默认状态为"草稿"，需要手动激活

**输出：**
- 创建成功：返回促销活动ID
- 创建失败：返回具体错误原因

#### 3.1.3 更新促销活动

**功能描述：**
运营可以修改促销活动的配置信息。

**业务规则：**
- 只能修改草稿状态或已暂停的活动
- 进行中的活动只能暂停，不能修改核心规则（条件值、优惠值）
- 已结束的活动不能修改
- 修改后需要重新审核（如果原活动已激活）

#### 3.1.4 查询促销活动

**功能描述：**
支持按条件查询促销活动列表，支持分页。

**查询条件：**
- 促销类型（可选）
- 活动状态（可选）
- 关键词（促销名称模糊搜索）
- 分页参数（页码、每页数量）

**返回信息：**
- 促销活动列表
- 每个活动包含：ID、名称、类型、条件值、优惠值、时间范围、状态、已使用配额等
- 总记录数（用于分页）

#### 3.1.5 删除促销活动

**功能描述：**
软删除促销活动，已删除的活动不再对外展示。

**业务规则：**
- 只能删除草稿状态的活动
- 进行中的活动需要先暂停才能删除
- 已结束的活动可以删除（用于数据清理）

#### 3.1.6 查询可用促销活动

**功能描述：**
根据商品、类目、订单金额等条件，查询当前可用的促销活动。

**输入条件：**
- 商品ID列表（可选）
- 类目ID（可选）
- 订单总金额（必填）
- 用户ID（可选，用于限购判断）

**匹配规则：**
1. **时间匹配**：活动必须在有效期内（当前时间在开始时间和结束时间之间）
2. **状态匹配**：活动状态必须为"进行中"
3. **商品匹配**：
   - 如果活动指定了商品ID列表，订单中的商品必须在列表中
   - 如果活动指定了类目ID列表，订单中的商品类目必须在列表中
   - 如果活动未指定商品和类目，表示全平台通用
4. **金额匹配**：订单总金额必须满足活动的条件值（如：满200）
5. **限购匹配**：检查用户是否已达到限购次数
6. **配额匹配**：检查活动是否还有剩余配额

**输出：**
- 返回匹配的促销活动列表（按优先级排序）

---

### 3.2 优惠计算

#### 3.2.1 计算优惠金额

**功能描述：**
根据商品列表、订单金额、用户信息等，计算最终优惠金额。

**输入：**
- 商品ID列表
- 购物车商品列表（商品ID、SKU ID、数量、单价）
- 订单总金额
- 用户ID
- 使用的优惠券ID（可选）

**计算逻辑：**
1. **获取可用促销活动**
   - 根据商品、类目、金额等条件查询可用促销
   - 按优先级排序（排序权重高的优先）

2. **计算促销优惠**
   - 遍历可用促销活动，按类型计算优惠：
     - **满减**：订单金额 >= 条件值，优惠 = 优惠值
     - **满折**：订单金额 >= 条件值，优惠 = 订单金额 * (1 - 优惠值)
     - **直降**：商品在活动范围内，优惠 = 优惠值 * 数量
     - **限时折扣**：商品在活动范围内且在时间范围内，优惠 = 商品金额 * (1 - 优惠值)
   - 处理优惠叠加规则（见下文）

3. **计算优惠券优惠**
   - 如果用户选择了优惠券：
     - 检查优惠券是否有效（未使用、在有效期内、满足使用条件）
     - 根据优惠券类型计算优惠：
       - **固定金额券**：优惠 = 优惠值
       - **折扣券**：优惠 = 订单金额 * (1 - 优惠值)
       - **免运费券**：优惠 = 运费金额

4. **优惠叠加规则**
   - 促销优惠和优惠券优惠可以叠加
   - 多个促销活动按优先级选择最优的一个（不叠加）
   - 最终优惠金额 = 促销优惠 + 优惠券优惠
   - 最终实付金额 = 订单总金额 - 最终优惠金额（不能小于0）

**输出：**
- 商品总金额
- 促销优惠金额
- 优惠券优惠金额
- 总优惠金额
- 最终实付金额
- 应用的促销活动列表
- 应用的优惠券信息

---

### 3.3 优惠券管理

#### 3.3.1 优惠券类型

**固定金额券（FIXED）**
- 功能描述：直接减免固定金额
- 示例：10元优惠券、50元优惠券
- 优惠值：固定金额（如：10）

**折扣券（PERCENT）**
- 功能描述：按折扣比例计算优惠
- 示例：9折券、8折券
- 优惠值：折扣比例（如：0.9 表示9折）

**免运费券（FREE_SHIPPING）**
- 功能描述：减免运费
- 示例：免运费券
- 优惠值：运费金额（由订单服务计算）

#### 3.3.2 创建优惠券模板

**功能描述：**
运营创建优惠券模板，用于批量发放优惠券。

**输入字段：**
- 优惠券名称（必填）
- 优惠券类型（必填，1-固定金额，2-折扣，3-免运费）
- 优惠券描述（可选）
- 优惠值（必填，固定金额或折扣比例）
- 使用条件（可选，如：满100可用）
- 发放总数（可选，0表示不限制）
- 每人限领数量（可选，默认1）
- 有效期开始时间（必填）
- 有效期结束时间（必填）
- 领取后有效天数（可选，0表示使用模板有效期）

**业务规则：**
- 有效期开始时间必须早于结束时间
- 如果设置了发放总数，已领取数量不能超过总数
- 创建后默认状态为"启用"

**输出：**
- 创建成功：返回优惠券模板ID

#### 3.3.3 用户领取优惠券

**功能描述：**
用户从优惠券中心领取优惠券。

**输入：**
- 优惠券模板ID
- 用户ID

**业务规则：**
1. 检查优惠券模板是否存在且状态为"启用"
2. 检查模板是否在有效期内（当前时间在有效期范围内）
3. 检查总配额：如果设置了发放总数，已领取数量不能超过总数
4. 检查用户限领数量：用户已领取该模板的优惠券数量不能超过每人限领数量
5. 创建优惠券实例：
   - 如果模板设置了"领取后有效天数"，优惠券有效期 = 当前时间 + 有效天数
   - 否则，优惠券有效期 = 模板有效期
6. 更新模板的已领取数量

**输出：**
- 领取成功：返回优惠券ID
- 领取失败：返回具体错误原因（已领完、已达到限领数量等）

#### 3.3.4 查询用户优惠券列表

**功能描述：**
用户查看自己的优惠券列表。

**查询条件：**
- 用户ID（必填）
- 优惠券状态（可选，1-未使用，2-已使用，3-已过期）
- 分页参数（页码、每页数量）

**返回信息：**
- 优惠券列表（按状态和时间排序：未使用 > 已使用 > 已过期）
- 每个优惠券包含：ID、名称、类型、优惠值、使用条件、有效期、状态等
- 总记录数

**业务规则：**
- 自动检查并更新过期优惠券状态（如果优惠券已过期且未使用，状态更新为"已过期"）

#### 3.3.5 核销优惠券

**功能描述：**
用户下单支付成功后，系统核销使用的优惠券。

**输入：**
- 优惠券ID
- 用户ID
- 订单ID
- 订单金额

**业务规则：**
1. 检查优惠券是否存在
2. 检查优惠券是否属于该用户
3. 检查优惠券状态（必须为"未使用"）
4. 检查优惠券是否在有效期内
5. 检查订单金额是否满足使用条件（如果设置了使用条件）
6. 更新优惠券状态为"已使用"
7. 记录使用时间、订单ID等信息

**输出：**
- 核销成功：返回成功信息
- 核销失败：返回具体错误原因（优惠券不存在、已使用、已过期、不满足使用条件等）

---

## 4. 业务规则汇总

### 4.1 促销活动规则

**活动状态流转：**
- 草稿 → 进行中（手动激活）
- 进行中 → 已暂停（手动暂停）
- 已暂停 → 进行中（手动恢复）
- 进行中 → 已结束（时间到期或手动结束）
- 任何状态 → 已删除（软删除）

**活动优先级：**
- 按排序权重（sort_order）降序排列，权重高的优先
- 如果权重相同，按创建时间降序排列

**限购规则：**
- 如果设置了每人限用次数，用户使用该促销的次数不能超过限制
- 使用记录保存在 `promotion_usage_logs` 表中

**配额规则：**
- 如果设置了总配额，已使用配额不能超过总配额
- 每次使用促销时，已使用配额 +1

### 4.2 优惠券规则

**优惠券状态：**
- 未使用：优惠券已领取但未使用
- 已使用：优惠券已核销
- 已过期：优惠券已过期且未使用

**有效期规则：**
- 如果模板设置了"领取后有效天数"，优惠券有效期从领取时开始计算
- 否则，优惠券有效期使用模板的有效期

**使用条件规则：**
- 如果优惠券设置了使用条件（如：满100可用），订单金额必须满足条件才能使用
- 固定金额券和折扣券可以设置使用条件
- 免运费券不需要设置使用条件

### 4.3 优惠计算规则

**促销优惠计算：**
- 多个促销活动按优先级选择最优的一个（不叠加）
- 如果同时满足多个促销条件，选择优惠金额最大的

**优惠叠加规则：**
- 促销优惠和优惠券优惠可以叠加
- 最终优惠金额 = 促销优惠 + 优惠券优惠
- 最终实付金额不能小于0（如果优惠金额大于订单金额，实付金额为0）

**计算顺序：**
1. 先计算促销优惠（基于原价）
2. 再计算优惠券优惠（基于原价，不是促销后的价格）
3. 最终实付金额 = 原价 - 促销优惠 - 优惠券优惠

---

## 5. 数据概念

### 5.1 促销活动数据

**promotions 表：**
- 促销活动基本信息
- 促销类型、条件值、优惠值
- 时间范围、状态、配额
- 适用商品/类目范围

**promotion_usage_logs 表：**
- 促销使用记录
- 用于限购判断和配额统计
- 关联用户ID、订单ID、优惠金额

### 5.2 优惠券数据

**coupon_templates 表：**
- 优惠券模板信息
- 优惠券类型、优惠值、使用条件
- 发放总数、每人限领数量
- 有效期配置

**coupons 表：**
- 用户领取的优惠券实例
- 关联模板ID、用户ID
- 优惠券状态、使用时间、订单ID

---

## 6. 与其他服务的关系

### 6.1 被依赖关系

**购物车服务：**
- 查询可用促销活动
- 计算购物车优惠金额

**订单服务：**
- 下单时计算最终优惠金额
- 核销优惠券

**商品服务：**
- 查询商品信息（用于促销匹配）

### 6.2 依赖关系

**用户服务：**
- 查询用户信息（用于限购判断）

**商品服务：**
- 查询商品信息、类目信息（用于促销匹配）

---

## 7. 非功能需求

### 7.1 性能要求
- 优惠计算接口：P95响应时间 < 200ms
- 查询可用促销接口：P95响应时间 < 150ms
- 优惠券查询接口：P95响应时间 < 100ms

### 7.2 可用性要求
- 服务可用性：99.9%
- 优惠计算为核心功能，需优先保障可用性

### 7.3 数据一致性要求
- 优惠券核销需要保证幂等性（防止重复核销）
- 促销配额扣减需要保证原子性（防止超配额）

### 7.4 扩展性要求
- 支持促销活动数量：万级
- 支持优惠券数量：百万级
- 预留支持更复杂促销规则的能力（如：阶梯满减、组合优惠等）

---

## 8. 首期实现范围（MVP）

### 8.1 必须实现（核心功能）
- ✅ 促销活动管理（创建、查询、更新、删除）
- ✅ 满减活动（满X减Y）
- ✅ 优惠券模板管理
- ✅ 优惠券领取
- ✅ 优惠券查询
- ✅ 优惠券核销
- ✅ 可用促销活动查询
- ✅ 优惠金额计算（基础版）

### 8.2 可选实现（后续迭代）
- ⏳ 满折活动
- ⏳ 直降活动
- ⏳ 限时折扣活动
- ⏳ 优惠券折扣券
- ⏳ 优惠券免运费券
- ⏳ 促销活动优先级和叠加规则
- ⏳ 促销活动定时上下架

### 8.3 暂不实现（未来规划）
- 🔮 会员价（由会员服务负责）
- 🔮 积分抵扣（由积分服务负责）
- 🔮 复杂的促销规则引擎（阶梯满减、组合优惠等）
- 🔮 促销活动效果统计和分析

---

## 9. 验收标准

### 9.1 功能验收
- 运营可以成功创建促销活动
- 用户可以成功领取优惠券
- 购物车可以正确计算优惠金额
- 订单可以正确计算最终优惠金额
- 优惠券可以成功核销

### 9.2 性能验收
- 所有接口响应时间符合非功能需求要求
- 支持并发优惠计算（如100 QPS）

### 9.3 数据一致性验收
- 优惠券核销保证幂等性
- 促销配额扣减保证原子性

---

## 10. 后续优化方向

### 10.1 功能优化
- 支持更复杂的促销规则（阶梯满减、组合优惠）
- 支持促销活动效果统计和分析
- 支持促销活动自动上下架（定时任务）

### 10.2 性能优化
- 促销活动缓存（Redis）
- 优惠券列表缓存
- 优惠计算结果缓存

### 10.3 体验优化
- 优惠券过期提醒
- 促销活动倒计时展示
- 优惠明细可视化展示

---

**文档版本：** v1.0  
**最后更新：** 2024-12-20  
**文档维护：** 产品团队

